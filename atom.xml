<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Harthali</title>
  
  <subtitle>脑子可能有点不正常</subtitle>
  <link href="https://lihengtt.github.io/atom.xml" rel="self"/>
  
  <link href="https://lihengtt.github.io/"/>
  <updated>2025-12-05T07:26:53.792Z</updated>
  <id>https://lihengtt.github.io/</id>
  
  <author>
    <name>李恒</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ssh2提示无法交换加密密钥</title>
    <link href="https://lihengtt.github.io/2023/11/01/ssh2%E6%8F%90%E7%A4%BA%E6%97%A0%E6%B3%95%E4%BA%A4%E6%8D%A2%E5%8A%A0%E5%AF%86%E5%AF%86%E9%92%A5/"/>
    <id>https://lihengtt.github.io/2023/11/01/ssh2%E6%8F%90%E7%A4%BA%E6%97%A0%E6%B3%95%E4%BA%A4%E6%8D%A2%E5%8A%A0%E5%AF%86%E5%AF%86%E9%92%A5/</id>
    <published>2023-11-01T04:41:56.000Z</published>
    <updated>2025-12-05T07:26:53.792Z</updated>
    
    <content type="html"><![CDATA[<p>给客户在很早之前就通过宝塔安装了ssh2的扩展，但是一年后突然报出了错误<code>Unable to exchange encryption keys</code>，发现是因为libssh2和扩展版本太老的原因，以下记录手动更新扩展的过程。</p><span id="more"></span><h3 id="首先下载安装包"><a href="#首先下载安装包" class="headerlink" title="首先下载安装包"></a>首先下载安装包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.libssh2.org/download/libssh2-1.10.0.tar.gz</span><br><span class="line">$ wget http://pecl.php.net/get/ssh2-1.3.1.tgz</span><br></pre></td></tr></table></figure><h3 id="先安装-libssh2，会将libssh2安装到-usr-local-libssh2"><a href="#先安装-libssh2，会将libssh2安装到-usr-local-libssh2" class="headerlink" title="先安装 libssh2，会将libssh2安装到&#x2F;usr&#x2F;local&#x2F;libssh2"></a>先安装 libssh2，会将libssh2安装到&#x2F;usr&#x2F;local&#x2F;libssh2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf libssh2-1.10.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> libssh2-1.10.0/</span><br><span class="line">$ ./configure --prefix=/usr/local/libssh2</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="再安装ssh2扩展"><a href="#再安装ssh2扩展" class="headerlink" title="再安装ssh2扩展"></a>再安装ssh2扩展</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf ssh2-1.3.1.tgz </span><br><span class="line">$ <span class="built_in">cd</span> ssh2-1.3.1/</span><br><span class="line">$ /www/server/php/74/bin/phpize</span><br><span class="line">$ ./configure --prefix=/usr/local/ssh2 --with-ssh2=/usr/local/libssh2 --with-php-config=/www/server/php/74/bin/php-config</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="php-ini写入扩展"><a href="#php-ini写入扩展" class="headerlink" title="php.ini写入扩展"></a>php.ini写入扩展</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=ssh2.so</span><br></pre></td></tr></table></figure><p>重载php，查看phpinfo();，看到对应你刚才安装的版本就行了</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;给客户在很早之前就通过宝塔安装了ssh2的扩展，但是一年后突然报出了错误&lt;code&gt;Unable to exchange encryption keys&lt;/code&gt;，发现是因为libssh2和扩展版本太老的原因，以下记录手动更新扩展的过程。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>负载排查日志记录</title>
    <link href="https://lihengtt.github.io/2021/08/17/%E8%B4%9F%E8%BD%BD%E6%8E%92%E6%9F%A5%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/"/>
    <id>https://lihengtt.github.io/2021/08/17/%E8%B4%9F%E8%BD%BD%E6%8E%92%E6%9F%A5%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/</id>
    <published>2021-08-17T09:47:05.000Z</published>
    <updated>2025-12-05T07:26:53.803Z</updated>
    
    <content type="html"><![CDATA[<p>下班之际，突然出现的问题，出现了mysql many connect，心塞。<br>直接上服务器</p><span id="more"></span><h2 id="top命令"><a href="#top命令" class="headerlink" title="top命令"></a>top命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">top - 10:11:18 up 45 days, 17:38,  2 <span class="built_in">users</span>,  load average: 12.14, 8.20, 4.58</span><br><span class="line">Tasks: 544 total,   1 running, 542 sleeping,   0 stopped,   1 zombie</span><br><span class="line">%Cpu(s): 15.2 us,  5.2 sy,  0.0 ni, 79.3 <span class="built_in">id</span>,  0.3 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  3881920 total,   278624 free,  1525840 used,  2077456 buff/cache</span><br><span class="line">KiB Swap:  1049596 total,   3 free,    1049593 used.  1844424 avail Mem </span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                                                    </span><br><span class="line"> 8758 root      10 -10  174128  52928   5200 S   5.6  1.4 286:24.76 AliYunDun                                                                                                                                                                  </span><br><span class="line">  494 dbus      20   0   28368   4600    440 S   0.7  0.1 406:50.17 dbus-daemon                                                                                                                                                                </span><br><span class="line">10819 root      20   0  159184   3792   1596 S   0.7  0.1   0:00.10 top                                                                                                                                                                        </span><br><span class="line">11790 root      20   0  158168   2784   1580 R   0.7  0.1   0:00.05 top                                                                                                                                                                        </span><br><span class="line">    1 root      20   0  191476   2996   1228 S   0.3  0.1 293:27.53 systemd                                                                                                                                                                    </span><br><span class="line">    9 root      20   0       0      0      0 S   0.3  0.0  54:58.90 rcu_sched                                                                                                                                                                  </span><br><span class="line">  466 root      16  -4   55524    792    336 S   0.3  0.0  22:44.25 auditd                                                                                                                                                                     </span><br><span class="line">  543 root      20   0  342392  26176   1068 S   0.3  0.7  72:56.68 firewalld                                                                                                                                                                  </span><br><span class="line"> 2833 redis     20   0  159516   3376    956 S   0.3  0.1  76:19.86 redis-server                                                                                                                                                               </span><br><span class="line"> 3514 mysql     20   0 1753780 614536      0 S   0.3 15.8 115:27.34 mysqld                                                                                                                                                                     </span><br><span class="line"> 7760 root      10 -10   42152   2636    960 S   0.3  0.1   3:39.75 AliYunDunUpdate                                                                                                                                                            </span><br><span class="line">    2 root      20   0       0      0      0 S   0.0  0.0   0:01.22 kthreadd                                                                                                                                                                   </span><br><span class="line">    3 root      20   0       0      0      0 S   0.0  0.0   4:33.51 ksoftirqd/0                                                                                                                                                                </span><br><span class="line">    5 root       0 -20       0      0      0 S   0.0  0.0   0:00.00 kworker/0:0H                                                                                                                                                               </span><br><span class="line">    7 root      rt   0       0      0      0 S   0.0  0.0   2:30.64 migration/0                                                                                                                                                                </span><br><span class="line">    8 root      20   0       0      0      0 S   0.0  0.0   0:00.00 rcu_bh                                                                                                                                                                     </span><br><span class="line">   10 root      rt   0       0      0      0 S   0.0  0.0   0:10.75 watchdog/0                                                                                                                                                                 </span><br><span class="line">   11 root      rt   0       0      0      0 S   0.0  0.0   0:09.12 watchdog/1                                                                                                                                                                 </span><br><span class="line">   12 root      rt   0       0      0      0 S   0.0  0.0   2:31.28 migration/1                                                                                                                                                                </span><br><span class="line">   13 root      20   0       0      0      0 S   0.0  0.0   4:46.43 ksoftirq</span><br></pre></td></tr></table></figure><h4 id="第一行：top-10-11-18-up-45-days-17-38-2-users-load-average-12-14-8-20-4-58"><a href="#第一行：top-10-11-18-up-45-days-17-38-2-users-load-average-12-14-8-20-4-58" class="headerlink" title="第一行：top - 10:11:18 up 45 days, 17:38,  2 users,  load average: 12.14, 8.20, 4.58"></a>第一行：top - 10:11:18 up 45 days, 17:38,  2 users,  load average: 12.14, 8.20, 4.58</h4><p>依次对应：系统当前时间 up 系统到目前为止i运行的时间， 当前登陆系统的用户数量， load average后面的三个数字分别表示距离现在一分钟，五分钟，十五分钟的负载情况。<br>这行信息与命令uptime显示的信息相同<br>注意：load average数据是每隔5秒钟检查一次活跃的进程数，然后按特定算法计算出的数值。如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了。</p><h4 id="top命令的第二行："><a href="#top命令的第二行：" class="headerlink" title="top命令的第二行："></a>top命令的第二行：</h4><p>Tasks: 544 total,   1 running, 542 sleeping,   0 stopped,   1 zombie<br>依次对应：tasks表示任务（进程），544 544，其中处于运行中的有1个，542（挂起），stopped状态即停止的进程数为0，zombie状态即僵尸的进程数为1个。</p><h4 id="top命令的第三行，cpu状态："><a href="#top命令的第三行，cpu状态：" class="headerlink" title="top命令的第三行，cpu状态："></a>top命令的第三行，cpu状态：</h4><p>%Cpu(s): 15.2 us,  5.2 sy,  0.0 ni, 79.3 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 st<br>依次对应：<br>us:user 用户空间占用cpu的百分比<br>sy:system 内核空间占用cpu的百分比<br>ni:niced 改变过优先级的进程占用cpu的百分比<br>id:空闲cpu百分比<br>wa:IO wait IO等待占用cpu的百分比<br>hi:Hardware IRQ 硬中断 占用cpu的百分比<br>si:software 软中断 占用cpu的百分比<br>st:被hypervisor偷去的时间</p><h4 id="top命令第四行，内存状态："><a href="#top命令第四行，内存状态：" class="headerlink" title="top命令第四行，内存状态："></a>top命令第四行，内存状态：</h4><p>KiB Mem :  3881920 total,   278624 free,  1525840 used,  2077456 buff&#x2F;cache<br>依次对应：物理内存总量（3.8G),空闲内存总量（2.7G),使用中的内存总量（1.5G),缓冲内存量<br>第四行中使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在linux上free内存会越来越少，但不用为此担心 </p><h4 id="top命令第五行，swap交换分区："><a href="#top命令第五行，swap交换分区：" class="headerlink" title="top命令第五行，swap交换分区："></a>top命令第五行，swap交换分区：</h4><p>KiB Swap:  1049596 total,   3 free,    1049593 used.  1844424 avail Mem<br>依次对应：交换区总量（1G），空闲交换区总量（0G),使用的交换区总量（1G），可用交换取总量</p><p>对于内存监控，在top里我们要时刻监控第五行swap交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和swap的数据交换，这是真正的内存不够用了。</p><h4 id="top命令第七行，各进程的监控："><a href="#top命令第七行，各进程的监控：" class="headerlink" title="top命令第七行，各进程的监控："></a>top命令第七行，各进程的监控：</h4><p>PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND<br>依次对应： </p><ol><li>PID — 进程id </li><li>USER — 进程所有者 </li><li>PR — 进程优先级 </li><li>NI — nice值。负值表示高优先级，正值表示低优先级 </li><li>VIRT — 进程使用的虚拟内存总量，单位kb。VIRT&#x3D;SWAP+RES </li><li>RES — 进程使用的、未被换出的物理内存大小，单位kb。RES&#x3D;CODE+DATA </li><li>SHR — 共享内存大小，单位kb </li><li>S — 进程状态。D&#x3D;不可中断的睡眠状态 R&#x3D;运行 S&#x3D;睡眠 T&#x3D;跟踪&#x2F;停止 Z&#x3D;僵尸进程 </li><li>%CPU — 上次更新到现在的CPU时间占用百分比 </li><li>%MEM — 进程使用的物理内存百分比 </li><li>TIME+ — 进程使用的CPU时间总计，单位1&#x2F;100秒 </li><li>COMMAND — 进程名称（命令名&#x2F;命令行）</li></ol><h2 id="二-top交互命令"><a href="#二-top交互命令" class="headerlink" title="二.top交互命令"></a>二.top交互命令</h2><p>  1.1 ‘h’ 帮助<br>  top命令进入视图后，键入h会显示如下界面，显示交互命令的帮助菜单 </p><p>  1.2 敲ENTER或者 SPACE键: 刷新显示</p><p>  1.3 A’: 切换交替显示模式<br>  top命令视图下，键入‘A‘显示如下：<br>显示4个窗口：Def （默认字段组）<br>Job （任务字段组）<br>Mem （内存字段组）<br>Usr （用户字段组）<br>四组字段共有一个独立的可配置的概括区域和它自己的可配置任务区域。4个窗口中只有一个窗口是当前窗口。当前窗口的名称显示在左上方。（注：只有当前窗口才会接受你键盘交互命令）<br>我们可以用’a’和’w’在4个 窗口间切换。’a’移到后一个窗口，’w’移到前一个窗口。用’g’命令你可以输入一个数字来选择当前窗口。<br>在键入‘A‘后在键入‘a‘的显示如下： </p><p>1.4 ‘B’: 触发粗体显示<br>一些重要信息会以加粗字体显示。这个命令可以切换粗体显示</p><p>1.5 ‘d’ 或‘s’: 设置显示的刷新间隔<br>当键下’d’或’s’时，你将被提示输入一个值（以秒为单位），它会以设置的值作为刷新间隔。如果你这里输入了6.0，top将会每秒刷新<br>1.6 ‘l’、‘t’、‘m’: 切换负载、任务、内存信息的显示</p><p>1.7 ‘f’: 字段管理<br>用于选择你想要显示的字段。用’*’标记的是已选择的。 </p><p>上下光标键在字段内导航，左光标键可以选择字段，回车或右光标键确认。</p><p>按’&lt;’移动已排序的字段到左边，’&gt;’则移动到右边。 </p><p>1.8 ‘R’: 反向排序</p><p>1.9 ‘c’: 触发命令<br>切换是否显示进程启动时的完整路径和程序名。 </p><p>键入‘c’后显示：<br>2.0 ‘i’: 空闲任务<br>切换显示空闲任务 </p><h4 id="top中的load-average值的含义–针对的是cpu"><a href="#top中的load-average值的含义–针对的是cpu" class="headerlink" title="top中的load average值的含义–针对的是cpu"></a>top中的load average值的含义–针对的是cpu</h4><ol><li>单核处理器<br>假设我们的系统是单CPU单内核的，把它比喻成是一条单向马路，把CPU任务比作汽车。当车不多的时候，load &lt;1；当车占满整个马路的时候 load&#x3D;1；当马路都站满了，而且马路外还堆满了汽车的时候，load&gt;1</li><li>多核处理器<br>我们经常会发现服务器Load &gt; 1但是运行仍然不错，那是因为服务器是多核处理器（Multi-core）。<br>假设我们服务器CPU是2核，那么将意味我们拥有2条马路，我们的Load &#x3D; 2时，所有马路都跑满车辆。<br>注：查看cpu 核数命令：<br>grep ‘model name’ &#x2F;proc&#x2F;cpuinfo | wc -l</li><li>什么样的Load average值要提高警惕<br>0.7 &lt; load &lt; 1: 此时是不错的状态，如果进来更多的汽车，你的马路仍然可以应付。<br>load &#x3D; 1: 你的马路即将拥堵，而且没有更多的资源额外的任务，赶紧看看发生了什么吧。<br>load &gt; 5: 非常严重拥堵，我们的马路非常繁忙，每辆车都无法很快的运行</li><li>三种Load值，应该看哪个<br>通常我们先看15分钟load，如果load很高，再看1分钟和5分钟负载，查看是否有下降趋势。<br>1分钟负载值 &gt; 1，那么我们不用担心，但是如果15分钟负载都超过1，我们要赶紧看看发生了什么事情。所以我们要根据实际情况查看这三个值</li></ol><h4 id="swap和内存"><a href="#swap和内存" class="headerlink" title="swap和内存"></a>swap和内存</h4><p>swap是什么？<br>Linux系统的Swap分区，即交换区，Swap空间的作用可简单描述为：当系统的物理内存不够用的时候，就需要将物理内存中的一部分空间释放出来，以供当前运行的程序使用。那些被释放的空间可能来自一些很长时间没有什么操作的程序，这些被释放的空间被临时保存到Swap空间中，等到那些程序要运行时，再从Swap中恢复保存的数据到内存中。这样，系统总是在物理内存不够时，才进行Swap交换。其实，Swap的调整对Linux服务器，特别是Web服务器的性能至关重要。通过调整Swap，有时可以越过系统性能瓶颈，节省系统升级费用。</p><p>什么时候使用swap？<br>交换分区并不是等到物理内存用尽了才使用的，是否尽量的使用或不使用swap，在内核空间有一个参数控制。</p><p>内核空间交换区分利用参数查看命令:cat &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;swappiness<br>参数说明：<br>swappiness&#x3D;0 的时候表示最大限度使用物理内存，然后才是swap空间；swappiness＝100 的时候表示积极的使用swap分区，并且把内存上的数据及时的搬运到swap空间里面。<br>考虑到以下情况：<br>1）安装系统时难以确定内存的负荷，如何设置交换分区大小。<br>2）系统中物理内存越大，所需交换分区就会越少。</p><p>swap大小设置<br>平时安装系统，swap默认都分内存的2倍，因为现在有硬盘空间都很大，也不在乎那几十G的空间。合理建议：</p><ol><li>内存:&lt;&#x3D;4g SWAP:4G</li><li>内存:4-16g SWAP:8G</li><li>内存:16-64g SWAP:16G</li><li>内存:64-256g SWAP:32G</li></ol><h4 id="wa：cpu等待磁盘写入完成时间"><a href="#wa：cpu等待磁盘写入完成时间" class="headerlink" title="wa：cpu等待磁盘写入完成时间"></a>wa：cpu等待磁盘写入完成时间</h4><p>如果一台机器看到wa特别高，那么一般说明是磁盘IO出现问题，可以使用iostat等命令继续进行详细分析。<br>iotop的命令可以看到具体是哪个进程占用 IO 高<br>如果要看具体是哪个磁盘 IO 高，则用-iostat</p><h3 id="查看服务器IO状态-iostat"><a href="#查看服务器IO状态-iostat" class="headerlink" title="查看服务器IO状态-iostat"></a>查看服务器IO状态-iostat</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Linux 3.10.0-514.26.2.el7.x86_64 (izj6c13kpist8ckeii2xaaz)      08/18/2021      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">          12.17    0.00    4.31    1.00    0.00   82.52</span><br><span class="line"></span><br><span class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">vda              39.66       131.92       218.71  521475377  864535016</span><br></pre></td></tr></table></figure><h4 id="cpu属性值说明"><a href="#cpu属性值说明" class="headerlink" title="cpu属性值说明"></a>cpu属性值说明</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%user：CPU处在用户模式下的时间百分比。</span><br><span class="line"></span><br><span class="line">%<span class="built_in">nice</span>：CPU处在带NICE值的用户模式下的时间百分比。</span><br><span class="line"></span><br><span class="line">%system：CPU处在系统模式下的时间百分比。</span><br><span class="line"></span><br><span class="line">%iowait：CPU等待输入输出完成时间的百分比。</span><br><span class="line"></span><br><span class="line">%steal：管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比。</span><br><span class="line"></span><br><span class="line">%idle：CPU空闲时间百分比。</span><br></pre></td></tr></table></figure><h4 id="备注"><a href="#备注" class="headerlink" title="备注:"></a>备注:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如果%iowait的值过高，表示硬盘存在I/O瓶颈</span><br><span class="line"></span><br><span class="line">如果%idle值高，表示CPU较空闲</span><br><span class="line"></span><br><span class="line">如果%idle值高但系统响应慢时，可能是CPU等待分配内存，应加大内存容量。</span><br><span class="line"></span><br><span class="line">如果%idle值持续低于10，表明CPU处理能力相对较低，系统中最需要解决的资源是CPU。</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">记一次服务器负载排查</summary>
    
    
    
    
    <category term="linux" scheme="https://lihengtt.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Laravel-Vue-api数据加密解密</title>
    <link href="https://lihengtt.github.io/2021/07/02/Laravel-Vue-api%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/"/>
    <id>https://lihengtt.github.io/2021/07/02/Laravel-Vue-api%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/</id>
    <published>2021-07-02T08:14:30.000Z</published>
    <updated>2025-12-05T07:26:53.786Z</updated>
    
    <content type="html"><![CDATA[<p>很多app已经应用了这个场景，为了使前后端的交互更加安全，我们让前后端的交互数据都进行了加密和解密，为此我这里只是提供一个思路，Laravel和Vue交互的一个加密和解密案例。</p><span id="more"></span><h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>laravel的中间件刚好应用于我这个需求，即请求前中间件（request）和请求后中间件（response），在前端数据传过来的时候，我通过request拿到数据进行解密，并且交给我的后端程序，最后再把我需要返回的数据交给response进行加密。</p><h3 id="创建中间件"><a href="#创建中间件" class="headerlink" title="创建中间件"></a>创建中间件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:middleware SecretMiddleware</span><br></pre></td></tr></table></figure><h3 id="再Kernel-php进行注册别名"><a href="#再Kernel-php进行注册别名" class="headerlink" title="再Kernel.php进行注册别名"></a>再Kernel.php进行注册别名</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$routeMiddleware</span> = [</span><br><span class="line">       <span class="string">&#x27;secret&#x27;</span> =&gt; <span class="title class_">\App\Http\Middleware\SecretMiddleware</span>::<span class="variable language_">class</span>,</span><br><span class="line">   ];</span><br></pre></td></tr></table></figure><h3 id="添加到apiGroups中，这样就可以让我们所有的api路由就调用该中间件"><a href="#添加到apiGroups中，这样就可以让我们所有的api路由就调用该中间件" class="headerlink" title="添加到apiGroups中，这样就可以让我们所有的api路由就调用该中间件"></a>添加到apiGroups中，这样就可以让我们所有的api路由就调用该中间件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$middlewareGroups</span> = [</span><br><span class="line">        <span class="string">&#x27;web&#x27;</span> =&gt; [</span><br><span class="line">            <span class="title class_">\App\Http\Middleware\EncryptCookies</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Session\Middleware\StartSession</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="comment">// \Illuminate\Session\Middleware\AuthenticateSession::class,</span></span><br><span class="line">            <span class="title class_">\Illuminate\View\Middleware\ShareErrorsFromSession</span>::<span class="variable language_">class</span>,</span><br><span class="line"><span class="comment">//            \App\Http\Middleware\VerifyCsrfToken::class,</span></span><br><span class="line">            <span class="title class_">\Illuminate\Routing\Middleware\SubstituteBindings</span>::<span class="variable language_">class</span>,</span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;api&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;throttle:api&#x27;</span>,</span><br><span class="line">            <span class="title class_">\Illuminate\Routing\Middleware\SubstituteBindings</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="title class_">EnsureFrontendRequestsAreStateful</span>::<span class="variable language_">class</span>,</span><br><span class="line">            <span class="string">&#x27;secret&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br></pre></td></tr></table></figure><h3 id="SecretMiddleware-php"><a href="#SecretMiddleware-php" class="headerlink" title="SecretMiddleware.php"></a>SecretMiddleware.php</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">Request <span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">input</span>()) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable">$body</span> = <span class="title class_">\Arr</span>::<span class="title function_ invoke__">first</span>(<span class="title function_ invoke__">array_keys</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">input</span>()));</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$body</span>) &#123;</span><br><span class="line">                <span class="variable">$body</span> = <span class="title class_">Functions</span>::<span class="title function_ invoke__">decrypt_pass</span>(<span class="variable">$body</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$body</span>)&#123;</span><br><span class="line">                    <span class="title function_ invoke__">parse_str</span>(<span class="title function_ invoke__">http_build_query</span>(<span class="variable">$body</span>), <span class="variable">$input</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">merge</span>(<span class="variable">$input</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$response</span> =  <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$content</span> = <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getContent</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$content</span>) &#123;</span><br><span class="line">            <span class="variable">$content</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$content</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment"># 对 content 进行加密处理</span></span><br><span class="line">            <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">setContent</span>(<span class="title class_">Functions</span>::<span class="title function_ invoke__">encrypt_pass</span>(<span class="variable">$content</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>Vue这里我们用axios的request拦截器和response拦截器，分别进行了加密和解密，代码如下:</p><h3 id="请求拦截器"><a href="#请求拦截器" class="headerlink" title="请求拦截器"></a>请求拦截器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request interceptor</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (store.<span class="property">getters</span>.<span class="property">token</span>) &#123;</span><br><span class="line">      config.<span class="property">headers</span>[<span class="string">&#x27;Authorization&#x27;</span>] = <span class="string">&#x27;Bearer &#x27;</span> + <span class="title function_">getToken</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> aesEncryptData = aes.<span class="title function_">encrypt</span>(config.<span class="property">data</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (aesEncryptData) &#123;</span><br><span class="line">      </span><br><span class="line">      config.<span class="property">data</span> = aesEncryptData</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error) <span class="comment">// for debug</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="相应拦截器"><a href="#相应拦截器" class="headerlink" title="相应拦截器"></a>相应拦截器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * If you want to get http information such as headers or status</span></span><br><span class="line"><span class="comment">   * Please return  response =&gt; response</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Determine the request status by custom code</span></span><br><span class="line"><span class="comment">   * Here is just an example</span></span><br><span class="line"><span class="comment">   * You can also judge the status by HTTP Status Code</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(aes.<span class="title function_">decrypt</span>(response.<span class="property">data</span>))</span><br><span class="line">    <span class="comment">// if the custom code is not 20000, it is judged as an error.</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">code</span> !== <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">code</span> === <span class="number">500</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (res.<span class="property">msg</span> === <span class="string">&#x27;validation.required&#x27;</span>)&#123;</span><br><span class="line">          res.<span class="property">msg</span> = <span class="string">&#x27;验证失败&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Message</span>.<span class="title function_">error</span>(&#123;</span><br><span class="line">          <span class="attr">content</span>: res.<span class="property">msg</span> || <span class="string">&#x27;Error&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">code</span> === <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="title class_">Message</span>.<span class="title function_">error</span>(&#123;</span><br><span class="line">          <span class="attr">content</span>: <span class="string">&#x27;登录状态不正确&#x27;</span> || <span class="string">&#x27;Error&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(res.<span class="property">msg</span> || <span class="string">&#x27;Error&#x27;</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error.<span class="property">response</span>) <span class="comment">// for debug</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">response</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (error.<span class="property">response</span>.<span class="property">status</span> === <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="comment">// store.dispatch(&#x27;login/qzlogout&#x27;)</span></span><br><span class="line">        <span class="title class_">Message</span>.<span class="title function_">error</span>(&#123;</span><br><span class="line">          <span class="attr">content</span>: <span class="string">&#x27;登录状态不正确，请重新登录&#x27;</span> || <span class="string">&#x27;Error&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="最后关于前后端加密和解密的文件我就不展示了，有需要探讨的可以加我联系方式～"><a href="#最后关于前后端加密和解密的文件我就不展示了，有需要探讨的可以加我联系方式～" class="headerlink" title="最后关于前后端加密和解密的文件我就不展示了，有需要探讨的可以加我联系方式～"></a>最后关于前后端加密和解密的文件我就不展示了，有需要探讨的可以加我联系方式～</h3><p><img src="/pexels-%D0%BC%D0%B0%D0%BA%D1%81%D0%B8%D0%BC-%D0%B8%D1%81%D1%82%D0%BE%D0%BC%D0%B8%D0%BD-8545950.jpg" alt="Laravel-Vue-api数据加密解密" title="Laravel-Vue-api数据加密解密"></p>]]></content>
    
    
    <summary type="html">Laravel和Vue交互数据加密，解密</summary>
    
    
    
    
    <category term="php" scheme="https://lihengtt.github.io/tags/php/"/>
    
    <category term="Laravel" scheme="https://lihengtt.github.io/tags/Laravel/"/>
    
    <category term="Vue" scheme="https://lihengtt.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>SOCKS5一键脚本</title>
    <link href="https://lihengtt.github.io/2021/06/09/SOCKS5%E4%B8%80%E9%94%AE%E8%84%9A%E6%9C%AC/"/>
    <id>https://lihengtt.github.io/2021/06/09/SOCKS5%E4%B8%80%E9%94%AE%E8%84%9A%E6%9C%AC/</id>
    <published>2021-06-09T02:05:46.000Z</published>
    <updated>2025-12-05T07:26:53.790Z</updated>
    
    <content type="html"><![CDATA[<p>抄袭来的哈哈哈</p><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Dante Socks5 Server AutoInstall</span></span><br><span class="line"><span class="comment">#   -- Owner:       https://www.inet.no/dante</span></span><br><span class="line"><span class="comment">#   -- Provider:    https://sockd.info</span></span><br><span class="line"><span class="comment">#   -- Author:      Lozy</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if user is root</span></span><br><span class="line"><span class="keyword">if</span> [ $(<span class="built_in">id</span> -u) != <span class="string">&quot;0&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: You must be root to run this script, please use root to install&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">REQUEST_SERVER=<span class="string">&quot;https://raw.github.com/Lozy/danted/master&quot;</span></span><br><span class="line">SCRIPT_SERVER=<span class="string">&quot;https://public.sockd.info&quot;</span></span><br><span class="line">SYSTEM_RECOGNIZE=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;--no-github&quot;</span> ] &amp;&amp; REQUEST_SERVER=<span class="variable">$&#123;SCRIPT_SERVER&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -s <span class="string">&quot;/etc/os-release&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    os_name=$(sed -n <span class="string">&#x27;s/PRETTY_NAME=&quot;\(.*\)&quot;/\1/p&#x27;</span> /etc/os-release)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="subst">$(echo $&#123;os_name&#125; | grep -Ei &#x27;Debian|Ubuntu&#x27; )</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Current OS: %s\n&quot;</span> <span class="string">&quot;<span class="variable">$&#123;os_name&#125;</span>&quot;</span></span><br><span class="line">        SYSTEM_RECOGNIZE=<span class="string">&quot;debian&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> [ -n <span class="string">&quot;<span class="subst">$(echo $&#123;os_name&#125; | grep -Ei &#x27;CentOS&#x27;)</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Current OS: %s\n&quot;</span> <span class="string">&quot;<span class="variable">$&#123;os_name&#125;</span>&quot;</span></span><br><span class="line">        SYSTEM_RECOGNIZE=<span class="string">&quot;centos&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Current OS: %s is not support.\n&quot;</span> <span class="string">&quot;<span class="variable">$&#123;os_name&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">elif</span> [ -s <span class="string">&quot;/etc/issue&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="subst">$(grep -Ei &#x27;CentOS&#x27; /etc/issue)</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;Current OS: %s\n&quot;</span> <span class="string">&quot;<span class="subst">$(grep -Ei &#x27;CentOS&#x27; /etc/issue)</span>&quot;</span></span><br><span class="line">        SYSTEM_RECOGNIZE=<span class="string">&quot;centos&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;+++++++++++++++++++++++\n&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> /etc/issue</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;+++++++++++++++++++++++\n&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;[Error] Current OS: is not available to support.\n&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;[Error] (/etc/os-release) OR (/etc/issue) not exist!\n&quot;</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;[Error] Current OS: is not available to support.\n&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$SYSTEM_RECOGNIZE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    wget -qO- --no-check-certificate <span class="variable">$&#123;REQUEST_SERVER&#125;</span>/install_<span class="variable">$&#123;SYSTEM_RECOGNIZE&#125;</span>.sh | \</span><br><span class="line">        bash -s -- $*</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;[Error] Installing terminated&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash install.sh --port=端口 --user=用户名 --passwd=密码</span><br></pre></td></tr></table></figure><h3 id="安装后使用说明"><a href="#安装后使用说明" class="headerlink" title="安装后使用说明"></a>安装后使用说明</h3><table><thead><tr><th align="left">command</th><th align="left">option</th><th>description</th></tr></thead><tbody><tr><td align="left">service sockd start</td><td align="left">/etc/init.d/sockd start</td><td>start socks5 server daemon</td></tr><tr><td align="left">service sockd stop</td><td align="left">/etc/init.d/sockd stop</td><td>stop socks5 server daemon</td></tr><tr><td align="left">service sockd restart</td><td align="left">/etc/init.d/sockd restart</td><td>restart socks5 server daemon</td></tr><tr><td align="left">service sockd reload</td><td align="left">/etc/init.d/sockd reload</td><td>reload socks5 server daemon</td></tr><tr><td align="left">service sockd restart</td><td align="left">/etc/init.d/sockd restart</td><td>restart socks5 server daemon</td></tr><tr><td align="left">service sockd status</td><td align="left"></td><td>systemd process status</td></tr><tr><td align="left">service sockd state</td><td align="left">/etc/init.d/sockd state</td><td>running state</td></tr><tr><td align="left">service sockd tail</td><td align="left">/etc/init.d/sockd tail</td><td>sock log tail</td></tr><tr><td align="left">service sockd adduser</td><td align="left">/etc/init.d/sockd adduser</td><td>add pam-auth user: service sockd adduser NAME PASSWORD</td></tr><tr><td align="left">service sockd deluser</td><td align="left">/etc/init.d/sockd deluser</td><td>delete pam-auth user: service sockd deluser NAME</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">socks5一键安装脚本</summary>
    
    
    
    
    <category term="Centos" scheme="https://lihengtt.github.io/tags/Centos/"/>
    
    <category term="SOCKS5" scheme="https://lihengtt.github.io/tags/SOCKS5/"/>
    
  </entry>
  
  <entry>
    <title>MACPHP7.4安装SSH2</title>
    <link href="https://lihengtt.github.io/2021/04/28/MACPHP7-4%E5%AE%89%E8%A3%85SSH2/"/>
    <id>https://lihengtt.github.io/2021/04/28/MACPHP7-4%E5%AE%89%E8%A3%85SSH2/</id>
    <published>2021-04-28T03:55:11.000Z</published>
    <updated>2025-12-05T07:26:53.786Z</updated>
    
    <content type="html"><![CDATA[<p>记录一下在mac上面安装php7.4的ssh2扩展</p><span id="more"></span><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http://pecl.php.net/get/ssh2-1.2.tgz</span><br><span class="line">tar -zxvf ssh2-1.2.tgz</span><br><span class="line">cd ssh2-1.2</span><br><span class="line">phpize //注意使用自己对应版本的phpize</span><br><span class="line">./configure --with-php-config=/usr/local/bin/php-config //注意使用自己对应版本的php-config</span><br><span class="line">sudo make &amp;&amp; make install</span><br><span class="line">//完成过后修改php.ini 添加</span><br><span class="line">extension=ssh2.so</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">在mac上php7.4安装ssh2扩展</summary>
    
    
    
    
    <category term="PHP" scheme="https://lihengtt.github.io/tags/PHP/"/>
    
    <category term="SSH2" scheme="https://lihengtt.github.io/tags/SSH2/"/>
    
  </entry>
  
  <entry>
    <title>centos扩容Swap分区</title>
    <link href="https://lihengtt.github.io/2021/01/07/centos%E6%89%A9%E5%AE%B9Swap%E5%88%86%E5%8C%BA/"/>
    <id>https://lihengtt.github.io/2021/01/07/centos%E6%89%A9%E5%AE%B9Swap%E5%88%86%E5%8C%BA/</id>
    <published>2021-01-07T02:26:53.000Z</published>
    <updated>2025-12-05T07:26:53.790Z</updated>
    
    <content type="html"><![CDATA[<p>Linux中Swap（即：交换分区），类似于Windows的虚拟内存，就是当内存不足的时候，把一部分硬盘空间虚拟成内存使用,从而解决内存容量不足的情况。</p><span id="more"></span><br>### 1.查看当前的swap容量<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1.0G        216M        556M         13M        235M        628M</span><br><span class="line">Swap:          259M          0B        259M</span><br></pre></td></tr></table></figure><br>### 2.创建一个空文件 大小自己定，一般swap大小是内存的两倍，我的内存1G，swap给2G也是可以的<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# dd if=/dev/zero of=/swapfile bs=1024 count=2048000</span><br><span class="line"></span><br><span class="line">2048000+0 records in</span><br><span class="line">2048000+0 records out</span><br><span class="line">2097152000 bytes (2.1 GB) copied, 13.6397 s, 154 MB/s</span><br></pre></td></tr></table></figure><h4 id="dd命令"><a href="#dd命令" class="headerlink" title="dd命令"></a>dd命令</h4><p>dd：用指定大小的块拷贝一个文件，并在拷贝的同时进行指定的转换。</p><p>注意：指定数字的地方若以下列字符结尾，则乘以相应的数字：b&#x3D;512；c&#x3D;1；k&#x3D;1024；w&#x3D;2</p><p>参数注释：<br>1. if&#x3D;文件名：输入文件名，缺省为标准输入。即指定源文件。&lt; if&#x3D;input file &gt;<br>2. of&#x3D;文件名：输出文件名，缺省为标准输出。即指定目的文件。&lt; of&#x3D;output file &gt;<br>3. count&#x3D;blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。<br>4. bs&#x3D;bytes：同时设置读入&#x2F;输出的块大小为bytes个字节。<br><br></p><h3 id="3-将创建的文件夹转换为Swap分区"><a href="#3-将创建的文件夹转换为Swap分区" class="headerlink" title="3.将创建的文件夹转换为Swap分区"></a>3.将创建的文件夹转换为Swap分区</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# mkswap /swapfile</span><br><span class="line">Setting up swapspace version 1, size = 2047996 KiB</span><br><span class="line">no label, UUID=bd10f3bb-e0c9-4d03-b84b-9c8c47a2a02a</span><br></pre></td></tr></table></figure><br><h3 id="4-将刚才转换的Swap分区加入Swap"><a href="#4-将刚才转换的Swap分区加入Swap" class="headerlink" title="4.将刚才转换的Swap分区加入Swap"></a>4.将刚才转换的Swap分区加入Swap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# swapon /swapfile</span><br><span class="line">swapon: /swapfile: insecure permissions 0644, 0600 suggested.</span><br></pre></td></tr></table></figure><br><h3 id="5-查看一下"><a href="#5-查看一下" class="headerlink" title="5. 查看一下"></a>5. 查看一下</h3><figure class="highlight plaintext"><figcaption><span>~]# swapon -s</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Filename                                Type            Size    Used    Priority</span><br><span class="line">/swap                                   file    266236  0       -1</span><br><span class="line">/swapfile                               file    2047996 0       -2</span><br><span class="line">[root@www ~]# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1.0G        219M         68M         13M        719M        615M</span><br><span class="line">Swap:          2.2G          0B        2.2G</span><br></pre></td></tr></table></figure><blockquote><p>见识略薄，也希望你们在使用的过程中能有所帮助！<br>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.github.io/2021/01/07/centos%E6%89%A9%E5%AE%B9Swap%E5%88%86%E5%8C%BA/">lihengc.github.io</a> </p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux中Swap（即：交换分区），类似于Windows的虚拟内存，就是当内存不足的时候，把一部分硬盘空间虚拟成内存使用,从而解决内存容量不足的情况。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://lihengtt.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>phpstorm断点调试php代码+XDEBUG断点</title>
    <link href="https://lihengtt.github.io/2020/12/02/%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95php%E4%BB%A3%E7%A0%81/"/>
    <id>https://lihengtt.github.io/2020/12/02/%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95php%E4%BB%A3%E7%A0%81/</id>
    <published>2020-12-02T03:27:04.000Z</published>
    <updated>2025-12-05T07:26:53.797Z</updated>
    
    <content type="html"><![CDATA[<p>今天记录一下使用在phpstorm中使用xdebug进行代码的调试，作用嘛就不用多说了，不管你是用于开发或者代码审计无疑都是利器。</p><span id="more"></span><h3 id="安装XDEBUG（如果你已安装则直接跳过该步骤）"><a href="#安装XDEBUG（如果你已安装则直接跳过该步骤）" class="headerlink" title="安装XDEBUG（如果你已安装则直接跳过该步骤）"></a>安装XDEBUG（如果你已安装则直接跳过该步骤）</h3><p>1.pecl安装</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pecl install xdebug</span><br></pre></td></tr></table></figure><p>2.下载 Xdebug <a href="http://xdebug.org/download.php%EF%BC%88%E6%B3%A8%E6%84%8F%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%89">http://xdebug.org/download.php（注意下载对应的版本）</a><br>3.编译安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget http://pecl.php.net/get/xdebug-2.5.5.tgz \</span><br><span class="line"></span><br><span class="line">  &amp;&amp; tar xzf xdebug-2.5.5.tgz &amp;&amp; cd xdebug-2.5.5/ \</span><br><span class="line"></span><br><span class="line">  &amp;&amp; phpize \</span><br><span class="line"></span><br><span class="line">  &amp;&amp; ./configure \</span><br><span class="line"></span><br><span class="line">  &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>注意：php5.6只能使用2.5及以下版本xdebug。</p><h3 id="php-ini配置解释"><a href="#php-ini配置解释" class="headerlink" title="php.ini配置解释"></a>php.ini配置解释</h3><p>我这里只介绍我用到的配置，本地调试。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zend_extension = &quot;/Applications/bin/php/ext/xdebug.so&quot;</span><br><span class="line">xdebug.remote_enable=1</span><br><span class="line">xdebug.var_display_max_depth = 512</span><br><span class="line">xdebug.profiler_append = 1</span><br><span class="line">xdebug.profiler_enable_trigger = 1</span><br><span class="line">xdebug.max_nesting_level = 200</span><br><span class="line">xdebug.profiler_output_dir = &quot;/Applications/logs/xdebug&quot;</span><br><span class="line">xdebug.profiler_output_name = &quot;cachegrind.out.%t.%p&quot;</span><br><span class="line">xdebug.remote_autostart = 1 //开启自动调试</span><br><span class="line">xdebug.remote_host = 127.0.0.1</span><br><span class="line">xdebug.remote_port = 9000</span><br></pre></td></tr></table></figure><p>关键参数也就那么几个，<code>remote_enable</code>,<code>zend_extension</code>,<code>remote_autostart</code>,<code>remote_host</code>,<code>remote_port</code>,其他参数无所谓，你想开写的话那么自行去了解作用。<br><br ><br>记得配置完成过后重启<code>php-fpm</code></p><h3 id="配置phpstorm"><a href="#配置phpstorm" class="headerlink" title="配置phpstorm"></a>配置phpstorm</h3><p><img src="/screely-1606881744877.png" alt="screely-1606881744877.png"></p><p>这里<code>DEBUG PORT</code>和上面<code>php.ini</code>配置的port一样即可</p><p><img src="/screely-1606881737410.png" alt="screely-1606881737410.png"></p><p>这里<code>IDE KEY</code>和上面<code>php.ini</code>配置的<code>xdebug.idekey</code>一样即可</p><p>然后打开监听<br><img src="/screely-1606881706317.png" alt="screely-1606881706317.png"></p><blockquote><p>见识略薄，也希望你们在使用的过程中能有所帮助！<br>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.github.io/2020/12/02/%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95php%E4%BB%A3%E7%A0%81/">lihengc.github.io</a> </p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天记录一下使用在phpstorm中使用xdebug进行代码的调试，作用嘛就不用多说了，不管你是用于开发或者代码审计无疑都是利器。&lt;/p&gt;</summary>
    
    
    
    
    <category term="PHP" scheme="https://lihengtt.github.io/tags/PHP/"/>
    
    <category term="PHPSTORM" scheme="https://lihengtt.github.io/tags/PHPSTORM/"/>
    
  </entry>
  
  <entry>
    <title>ERR_INCOMPLETE_CHUNKED_ENCODING</title>
    <link href="https://lihengtt.github.io/2020/11/18/ERR-INCOMPLETE-CHUNKED-ENCODING/"/>
    <id>https://lihengtt.github.io/2020/11/18/ERR-INCOMPLETE-CHUNKED-ENCODING/</id>
    <published>2020-11-18T02:09:09.000Z</published>
    <updated>2025-12-05T07:26:53.781Z</updated>
    
    <content type="html"><![CDATA[<p>前几天安装的环境运行<code>laravel-admin</code>提交表单的时候莫名奇妙出现页面500，于是排查代码问题，找了几遍都没有问题，于是我想到去看看nginx的错误日志，果然看到了一个错误，输入代理文件大小超过配置<code>proxy_temp_file_write_size</code>的时候，nginx会将文件写到临时目录下面，如果没有权限，就会出现这个错误</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open() &quot;/var/lib/nginx/tmp/fastcgi/3/00/0000000003&quot; failed (13: Permission denied) while reading upstream</span><br></pre></td></tr></table></figure><p>解决方法特别简单，查询到nginx到运行用户,再这是目录到所有者</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root]# </span><span class="language-bash">ps -ef | grep nginx</span></span><br><span class="line">phpuser   1790 21211  0 Nov17 ?        00:00:00 nginx: worker process</span><br><span class="line">phpuser   1791 21211  0 Nov17 ?        00:00:00 nginx: worker process</span><br><span class="line">root     21211     1  0 Nov17 ?        00:00:00 nginx: master process nginx</span><br><span class="line"><span class="meta prompt_">[root]# </span><span class="language-bash"><span class="built_in">chown</span> -R phpuser:phpuser /var/lib/nginx</span></span><br></pre></td></tr></table></figure><blockquote><p>见识略薄，也希望你们在使用的过程中能有所帮助！<br>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.github.io/2020/11/18/ERR-INCOMPLETE-CHUNKED-ENCODING/">lihengc.github.io</a> </p></blockquote>]]></content>
    
    
    <summary type="html">open() &quot;/var/lib/nginx/tmp/fastcgi/3/00/0000000003&quot; failed (13: Permission denied) while reading upstream</summary>
    
    
    
    
    <category term="PHP" scheme="https://lihengtt.github.io/tags/PHP/"/>
    
    <category term="Nginx" scheme="https://lihengtt.github.io/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>Nginx File not Found</title>
    <link href="https://lihengtt.github.io/2020/11/16/Nginx-File-not-Found/"/>
    <id>https://lihengtt.github.io/2020/11/16/Nginx-File-not-Found/</id>
    <published>2020-11-16T08:54:50.000Z</published>
    <updated>2025-12-05T07:26:53.787Z</updated>
    
    <content type="html"><![CDATA[<p>搭建php-fpm+nginx环境的时候遇到一个问题，File not Found，这个错误并不是nginx返回的，是php-fpm返回给我们的。<br>错误日志就像这样</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020/11/16 06:56:19 [error] 779#0: *1 FastCGI sent in stderr: &quot;Primary script unknown&quot; while reading response header from upstream, client: 125.67.11.11, server: account80.com, request: &quot;GET / HTTP/1.1&quot;, upstream: &quot;fastcgi://127.0.0.1:9000&quot;, host: &quot;18.2.246.3&quot;</span><br><span class="line">2020/11/16 06:56:20 [error] 779#0: *1 FastCGI sent in stderr: &quot;Primary script unknown&quot; while reading response header from upstream, client: 125.67.11.11, server: account80.com, request: &quot;GET / HTTP/1.1&quot;, upstream: &quot;fastcgi://127.0.0.1:9000&quot;, host: &quot;18.2.246.3&quot;</span><br></pre></td></tr></table></figure><p>网上的回答什么都有，众说纷纭，以下是我的总结</p><h2 id="1-nginx配置文件问题，找不到脚本文件"><a href="#1-nginx配置文件问题，找不到脚本文件" class="headerlink" title="1. nginx配置文件问题，找不到脚本文件"></a>1. nginx配置文件问题，找不到脚本文件</h2><p>以下配置正确，你不需要管其他的</p><p><code>SCRIPT_FILENAME  $document_root$fastcgi_script_name</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line"></span><br><span class="line">        #SCRIPT_FILENAME用$document_root，而不是具体路径</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-权限问题（这个相对来说比较复杂一点）"><a href="#2-权限问题（这个相对来说比较复杂一点）" class="headerlink" title="2. 权限问题（这个相对来说比较复杂一点）"></a>2. 权限问题（这个相对来说比较复杂一点）</h2><p>确保nginx用户和php用户是统一用户，当然你不考虑安全问题的话root也行<br>找配置的话可以这样，以下shell只是推荐使用。。。。</p><p><code>vim $(find / -name php-fpm.d/www.conf)</code></p><p><code>vim $(find / -name nginx.conf)</code><br>修改用户和用户组，然后重启nginx和php-fpm，如果出现报错建议关机砸掉！</p><p>这一步是nginx日志的操作者<br><code>vim $(find / -name logrotate.d)/nginx</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create 640 root adm</span><br></pre></td></tr></table></figure><p>如果你修改的非不是root用户的话记得给予权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R nginxuser:nginxuser (日志目录)</span><br><span class="line">chown -R nginxuser:nginxuser (缓存目录)</span><br><span class="line">chown -R nginxuser:nginxuser (程序目录)</span><br></pre></td></tr></table></figure><h2 id="3-SELINUX-关键来了记好笔记"><a href="#3-SELINUX-关键来了记好笔记" class="headerlink" title="3. SELINUX (关键来了记好笔记)"></a>3. SELINUX (关键来了记好笔记)</h2><p>当你确定你目录和权限没有问题的情况下，然后还一直反复出现file not found，<br>那么可以确定就是selinux的问题无疑了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chcon -R -t httpd_sys_content_t /var/www/show</span><br></pre></td></tr></table></figure><p>或者临时关闭selinux</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo setenforce 0</span><br></pre></td></tr></table></figure><p>又或者永久关闭，需要重启</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/selinux/config set SELINUX to disabled</span><br></pre></td></tr></table></figure><blockquote><p>见识略薄，也希望你们在使用的过程中能有所帮助！<br>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.github.io/2020/11/16/Nginx-File-not-Found/">lihengc.github.io</a> </p></blockquote>]]></content>
    
    
    <summary type="html">FastCGI sent in stderr: &quot;Primary script unknown&quot; while reading response header from upstream</summary>
    
    
    
    
    <category term="PHP" scheme="https://lihengtt.github.io/tags/PHP/"/>
    
    <category term="Nginx" scheme="https://lihengtt.github.io/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>PHP-IOC容器</title>
    <link href="https://lihengtt.github.io/2020/10/31/PHP-IOC%E5%AE%B9%E5%99%A8/"/>
    <id>https://lihengtt.github.io/2020/10/31/PHP-IOC%E5%AE%B9%E5%99%A8/</id>
    <published>2020-10-31T07:18:40.000Z</published>
    <updated>2025-12-05T07:26:53.788Z</updated>
    
    <content type="html"><![CDATA[<p>###容器是什么？</p><p>相信很多人听说过依赖注入，依赖注入实现的基础条件离不开容器，容器就是用来管理类依赖和注入的，负责服务的管理和解耦组件，最简单的理解我们可以把容器理解成一个超级大、专门存对象的数组。</p><span id="more"></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 当前容器对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$instance</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存放在容器里面到实例</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$instances</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">self</span>::<span class="variable">$instance</span>) &#123;</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$instance</span> = <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$instance</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对象实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ReflectionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;instances[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;instances[<span class="variable">$key</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$key</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定对象、闭包、类到容器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> null $concrete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ReflectionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$concrete</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$concrete</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;instances[<span class="variable">$key</span>] = <span class="variable">$concrete</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$concrete</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;instances[<span class="variable">$key</span>] = <span class="variable">$concrete</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$key</span>, <span class="variable">$concrete</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建类绑定到类实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $abstract</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> null $atgs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ReflectionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$atgs</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;instances[<span class="variable">$abstract</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;instances[<span class="variable">$abstract</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$object</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">invokeClass</span>(<span class="variable">$abstract</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;instances[<span class="variable">$abstract</span>] = <span class="variable">$object</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$object</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反射解析类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $abstract</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ReflectionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeClass</span>(<span class="params"><span class="variable">$abstract</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="variable">$reflectionClass</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionClass</span>(<span class="variable">$abstract</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取构造方法</span></span><br><span class="line">        <span class="variable">$construct</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">getConstructor</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取参数得到实例</span></span><br><span class="line">        <span class="variable">$params</span> = <span class="variable">$construct</span> ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parserParams</span>(<span class="variable">$construct</span>) : [];</span><br><span class="line">        <span class="variable">$object</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">newInstanceArgs</span>(<span class="variable">$params</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$object</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析构造方法参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $reflect</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ReflectionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserParams</span>(<span class="params">ReflectionMethod <span class="variable">$reflect</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="variable">$args</span> = [];</span><br><span class="line">        <span class="variable">$params</span> = <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getParameters</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$params</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$args</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$params</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$params</span> <span class="keyword">as</span> <span class="variable">$param</span>) &#123;</span><br><span class="line">                <span class="variable">$class</span> = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getClass</span>();</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$class</span>) &#123;</span><br><span class="line">                    <span class="variable">$args</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">make</span>(<span class="variable">$class</span>-&gt;<span class="title function_ invoke__">getName</span>());</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 获取变量的名称</span></span><br><span class="line">                <span class="variable">$name</span> = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getName</span>();</span><br><span class="line">                <span class="comment">// 默认值</span></span><br><span class="line">                <span class="variable">$def</span> = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// 如果有默认值，从默认值获取类型</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$param</span>-&gt;<span class="title function_ invoke__">isOptional</span>()) &#123;</span><br><span class="line">                    <span class="variable">$def</span> = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getDefaultValue</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$args</span>[] = <span class="variable">$_REQUEST</span>[<span class="variable">$name</span>] ?? <span class="variable">$def</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$args</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">容器是什么？相信很多人听说过依赖注入，依赖注入实现的基础条件离不开容器，容器就是用来管理类依赖和注入的</summary>
    
    
    
    
    <category term="PHP" scheme="https://lihengtt.github.io/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>基于mysql的http插件</title>
    <link href="https://lihengtt.github.io/2020/03/31/%E5%9F%BA%E4%BA%8Emysql%E7%9A%84http%E6%8F%92%E4%BB%B6/"/>
    <id>https://lihengtt.github.io/2020/03/31/%E5%9F%BA%E4%BA%8Emysql%E7%9A%84http%E6%8F%92%E4%BB%B6/</id>
    <published>2020-03-31T03:12:39.000Z</published>
    <updated>2025-12-05T07:26:53.793Z</updated>
    
    <content type="html"><![CDATA[<p>####环境</p><ol><li>系统：centos</li><li>宝塔：7.1.1</li><li>mysq：l5.5.62</li></ol><h4 id="适用业务"><a href="#适用业务" class="headerlink" title="适用业务"></a>适用业务</h4><p>某某公司遇到的业务是用户余额变化需要时时变化并且通知到用户，那么所存在到问题是系统里面用户资金操作特别多，不可能在每一个操作上面都去添加业务通知，那么所带来的代码量也比较大，<br>并且也可能改漏遗忘，以及代码耦合特别高。在这个时候找到来mysql-udf-http这个插件，前辈写咱们只管用。（业务类似都可适用）</p><span id="more"></span><h4 id="安装以及使用"><a href="#安装以及使用" class="headerlink" title="安装以及使用"></a>安装以及使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/mysql-udf-http/mysql-udf-http-1.0.tar.gz</span><br><span class="line">echo &quot;/www/server/mysql/lib&quot; &gt; /etc/ld.so.conf.d/mysql.conf</span><br><span class="line">/sbin/ldconfig</span><br><span class="line">tar zxvf mysql-udf-http-1.0.tar.gz</span><br><span class="line">cd ./mysql-udf-http-1.0/</span><br><span class="line">./configure --prefix=/www/server/mysql --with-mysql=/www/server/mysql/bin/mysql_config</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ln -s /www/server/mysql/lib/mysql-udf-http.so.0.0.0 /www/server/mysql/lib/plugin/mysql-udf-http.so</span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure><p>这里需要注意的是把<code>/www/server/mysql</code>数据库的目录替换成自己的目录就好</p><p>最后进入数据库创建函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create function http_get returns string soname &#x27;mysql-udf-http.so&#x27;;  </span><br><span class="line">create function http_post returns string soname &#x27;mysql-udf-http.so&#x27;;  </span><br><span class="line">create function http_put returns string soname &#x27;mysql-udf-http.so&#x27;;  </span><br><span class="line">create function http_delete returns string soname &#x27;mysql-udf-http.so&#x27;;  </span><br></pre></td></tr></table></figure><p>使用该函数通知自己的业务,创建触发器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DROP TRIGGER IF EXISTS `BalanceChange`;</span><br><span class="line">DELIMITER  ;;</span><br><span class="line">CREATE DEFINER=`root`@`127.0.0.1` TRIGGER `BalanceChange` AFTER UPDATE ON `account` FOR EACH ROW </span><br><span class="line">begin</span><br><span class="line">  SET @tt_resu = (SELECT http_post(&#x27;http://173.0.2.1/putMessage&#x27;,CONCAT(&#x27;uid=&#x27;,NEW.uid,&#x27;&amp;balance=&#x27;,NEW.balance,&#x27;&amp;site=&#x27;,NEW.site_id)));  </span><br><span class="line">end;;</span><br></pre></td></tr></table></figure><p>需要注意的仅仅只是参数的格式</p><blockquote><p>见识略薄，也希望你们在使用的过程中能有所帮助！<br>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.coding.me/2020/03/31/%E5%9F%BA%E4%BA%8Emysql%E7%9A%84http%E6%8F%92%E4%BB%B6/">lihengc.coding.me</a> </p></blockquote>]]></content>
    
    
    <summary type="html">基于mysql的http插件,MySQL安装mysql-udf-http,Mysql数据改变触发http通知</summary>
    
    
    
    
    <category term="mysql" scheme="https://lihengtt.github.io/tags/mysql/"/>
    
    <category term="http" scheme="https://lihengtt.github.io/tags/http/"/>
    
    <category term="tcp" scheme="https://lihengtt.github.io/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>thinkphp调用sqlserver储存过程返回多个结果集</title>
    <link href="https://lihengtt.github.io/2020/01/06/thinkphp%E8%B0%83%E7%94%A8sqlserver%E5%82%A8%E5%AD%98%E8%BF%87%E7%A8%8B%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E7%BB%93%E6%9E%9C%E9%9B%86/"/>
    <id>https://lihengtt.github.io/2020/01/06/thinkphp%E8%B0%83%E7%94%A8sqlserver%E5%82%A8%E5%AD%98%E8%BF%87%E7%A8%8B%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E7%BB%93%E6%9E%9C%E9%9B%86/</id>
    <published>2020-01-06T06:45:44.000Z</published>
    <updated>2025-12-05T07:26:53.792Z</updated>
    
    <content type="html"><![CDATA[<h3 id="首先安装扩展"><a href="#首先安装扩展" class="headerlink" title="首先安装扩展"></a>首先安装扩展</h3><span id="more"></span><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><p>分为两个步骤</p><ol><li>找到对应自己PHP版本的pdo扩展，下载解压出来，并且在<code>php.ini</code>里面启用扩展,需要注意的问题是php版本以及是否为安全版本</li><li>下载 <code>ODBC Driver</code>  <a href="https://docs.microsoft.com/zh-cn/sql/connect/odbc/download-odbc-driver-for-sql-server?view=sql-server-2017,%E8%BF%99%E4%B8%AA%E6%B2%A1%E5%95%A5%E6%B3%A8%E6%84%8F%E7%9A%84%EF%BC%8C%E4%BD%A0%E6%98%AF%E5%95%A5%E7%B3%BB%E7%BB%9F%E5%B0%B1%E4%B8%8B%E8%BD%BD%E5%95%A5%E5%AE%89%E8%A3%85%E5%8C%85%E5%B0%B1%E8%A1%8C">https://docs.microsoft.com/zh-cn/sql/connect/odbc/download-odbc-driver-for-sql-server?view=sql-server-2017,这个没啥注意的，你是啥系统就下载啥安装包就行</a></li></ol><p>linux 和 windows差不多，安装扩展的话直接可以用pecl</p><p>当你成功加载了可以在<code>phpinfo()</code>里面看到，当然了，如果你安装扩展这些都有诸多问题都话，～你可真拉稀。</p><hr /><h3 id="thinkphp操作sqlsrv储存过程"><a href="#thinkphp操作sqlsrv储存过程" class="headerlink" title="thinkphp操作sqlsrv储存过程"></a>thinkphp操作sqlsrv储存过程</h3><blockquote><p>我使用的tp版本是5.0和操作多个数据库，希望能对你有所帮助</p></blockquote><h4 id="配置config文件"><a href="#配置config文件" class="headerlink" title="配置config文件"></a>配置config文件</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 账号数据库</span></span><br><span class="line">   <span class="string">&#x27;UserDBConn&#x27;</span> =&gt;  [</span><br><span class="line">       <span class="string">&#x27;type&#x27;</span>            =&gt; <span class="string">&#x27;sqlsrv&#x27;</span>,</span><br><span class="line">       <span class="comment">// 服务器地址</span></span><br><span class="line">       <span class="string">&#x27;hostname&#x27;</span>        =&gt; <span class="string">&#x27;139.129.1.1&#x27;</span>,</span><br><span class="line">       <span class="comment">// 数据库名</span></span><br><span class="line">       <span class="string">&#x27;database&#x27;</span>        =&gt; <span class="string">&#x27;DB3&#x27;</span>,</span><br><span class="line">       <span class="comment">// 用户名</span></span><br><span class="line">       <span class="string">&#x27;username&#x27;</span>        =&gt; <span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">       <span class="comment">// 密码</span></span><br><span class="line">       <span class="string">&#x27;password&#x27;</span>        =&gt; <span class="string">&#x27;tt123!@#&#x27;</span>,</span><br><span class="line">       <span class="comment">// 端口</span></span><br><span class="line">       <span class="string">&#x27;hostport&#x27;</span>        =&gt; <span class="string">&#x27;5188&#x27;</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="comment">// 金币数据库</span></span><br><span class="line">   <span class="string">&#x27;ScoreDBConn&#x27;</span> =&gt;  [</span><br><span class="line">       <span class="string">&#x27;type&#x27;</span>            =&gt; <span class="string">&#x27;sqlsrv&#x27;</span>,</span><br><span class="line">       <span class="comment">// 服务器地址</span></span><br><span class="line">       <span class="string">&#x27;hostname&#x27;</span>        =&gt; <span class="string">&#x27;139.129.1.1&#x27;</span>,</span><br><span class="line">       <span class="comment">// 数据库名</span></span><br><span class="line">       <span class="string">&#x27;database&#x27;</span>        =&gt; <span class="string">&#x27;DB2&#x27;</span>,</span><br><span class="line">       <span class="comment">// 用户名</span></span><br><span class="line">       <span class="string">&#x27;username&#x27;</span>        =&gt; <span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">       <span class="comment">// 密码</span></span><br><span class="line">       <span class="string">&#x27;password&#x27;</span>        =&gt; <span class="string">&#x27;tt123!@#&#x27;</span>,</span><br><span class="line">       <span class="comment">// 端口</span></span><br><span class="line">       <span class="string">&#x27;hostport&#x27;</span>        =&gt; <span class="string">&#x27;5188&#x27;</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="comment">// 记录数据库</span></span><br><span class="line">   <span class="string">&#x27;RecordDBConn&#x27;</span> =&gt;  [</span><br><span class="line">       <span class="string">&#x27;type&#x27;</span>            =&gt; <span class="string">&#x27;sqlsrv&#x27;</span>,</span><br><span class="line">       <span class="comment">// 服务器地址</span></span><br><span class="line">       <span class="string">&#x27;hostname&#x27;</span>        =&gt; <span class="string">&#x27;139.129.1.1&#x27;</span>,</span><br><span class="line">       <span class="comment">// 数据库名</span></span><br><span class="line">       <span class="string">&#x27;database&#x27;</span>        =&gt; <span class="string">&#x27;DB1&#x27;</span>,</span><br><span class="line">       <span class="comment">// 用户名</span></span><br><span class="line">       <span class="string">&#x27;username&#x27;</span>        =&gt; <span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">       <span class="comment">// 密码</span></span><br><span class="line">       <span class="string">&#x27;password&#x27;</span>        =&gt; <span class="string">&#x27;tt123!@#&#x27;</span>,</span><br><span class="line">       <span class="comment">// 端口</span></span><br><span class="line">       <span class="string">&#x27;hostport&#x27;</span>        =&gt; <span class="string">&#x27;5188&#x27;</span></span><br><span class="line">   ],</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="修改thinkphp-library-think-Model-php"><a href="#修改thinkphp-library-think-Model-php" class="headerlink" title="修改thinkphp&#x2F;library&#x2F;think&#x2F;Model.php"></a>修改thinkphp&#x2F;library&#x2F;think&#x2F;Model.php</h4><p>在末尾追加</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> $DbconnName</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">Dbconn</span>(<span class="params"><span class="variable">$DbconnName</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           <span class="variable">$conn</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">connect</span>(<span class="variable">$DbconnName</span>);</span><br><span class="line">       &#125;<span class="keyword">catch</span> (\<span class="built_in">InvalidArgumentException</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">&#x27;连接异常&#x27;</span>;</span><br><span class="line">           <span class="keyword">die</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$conn</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="添加模型"><a href="#添加模型" class="headerlink" title="添加模型"></a>添加模型</h4><h5 id="Agent-php"><a href="#Agent-php" class="headerlink" title="Agent.php"></a>Agent.php</h5><p>查询和增删改都可以调用query，如果你没有想要获取的结果集的话可以调用<code>execute()</code>。</p><p><code>query()</code>有一个弊端，如果你的绑定参数的形式（非参数绑定）是直接写进sql的话，他有可能会判断你这个不是一个储存过程；<br>具体实现请查看thinkphp&#x2F;library&#x2F;think&#x2F;db&#x2F;Connection.php:368行，当然也不会有结果集返回。</p><p>你也可以用调用<code>procedure()</code>,这个方法调用的话就一定会返回结果集。</p><p>起初我就是这个问题，并没有采用绑定参数的形式提交，直接写sql，就获取不到结果集，后来我在我的sql提行里面加入了<code>SET NOCOUNT ON;</code>，才能勉强拿到返回，在文章最后我给出了我最开始获取的结果集的方案例子，但是真的拉稀，你们可以看看，不要吐槽。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Dbname</span> = <span class="string">&#x27;UserDBConn&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">GetIndirectAgentList</span>(<span class="params"><span class="variable">$agentId</span>,<span class="variable">$strAccount</span>,<span class="variable">$strSuperior</span>,<span class="variable">$iPageIndex</span>,<span class="variable">$pagesize</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$conn</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">Dbconn</span>(<span class="variable">$this</span>-&gt;Dbname);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="variable">$TotalCount</span> = <span class="number">0</span>;</span><br><span class="line">            <span class="variable">$res</span> = <span class="variable">$conn</span>::<span class="title function_ invoke__">query</span>(<span class="string">&#x27;exec [dbo].[Agent_GetAgentList] :agentId,:strAccount,:strSuperior,:iPageIndex,:pagesize,:TotalCount&#x27;</span>, [</span><br><span class="line">                <span class="string">&#x27;agentId&#x27;</span> =&gt; <span class="variable">$agentId</span>,</span><br><span class="line">                <span class="string">&#x27;strAccount&#x27;</span> =&gt; [<span class="variable">$strAccount</span>, PDO::<span class="variable constant_">PARAM_STR</span>],</span><br><span class="line">                <span class="string">&#x27;strSuperior&#x27;</span> =&gt; [<span class="variable">$strSuperior</span>, PDO::<span class="variable constant_">PARAM_STR</span>],</span><br><span class="line">                <span class="string">&#x27;iPageIndex&#x27;</span> =&gt; [<span class="variable">$iPageIndex</span>, PDO::<span class="variable constant_">PARAM_INT</span>],</span><br><span class="line">                <span class="string">&#x27;pagesize&#x27;</span> =&gt; [<span class="variable">$pagesize</span>, PDO::<span class="variable constant_">PARAM_INT</span>],</span><br><span class="line">                <span class="string">&#x27;TotalCount&#x27;</span> =&gt; [<span class="variable">$TotalCount</span>, PDO::<span class="variable constant_">PARAM_INPUT_OUTPUT</span>],</span><br><span class="line">            ]);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (PDOException <span class="variable">$e</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="最初的Agent-php"><a href="#最初的Agent-php" class="headerlink" title="最初的Agent.php"></a>最初的Agent.php</h5><p>很显然 这里并不会获取到@AgentID 以及  @TotalCount；他只会返回Agent_GetAgentList的结果集</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">GetIndirectAgentList</span>(<span class="params"><span class="variable">$agentId</span>,<span class="variable">$strAccount</span>,<span class="variable">$strSuperior</span>,<span class="variable">$iPageIndex</span>,<span class="variable">$pagesize</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$conn</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">Dbconn</span>(<span class="variable">$this</span>-&gt;Dbname);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$res</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;</span></span><br><span class="line"><span class="string">                SET NOCOUNT ON;</span></span><br><span class="line"><span class="string">                declare @AgentID int;</span></span><br><span class="line"><span class="string">                declare @TotalCount int;</span></span><br><span class="line"><span class="string">                exec [dbo].[Agent_GetAgentList] &#x27;</span>.<span class="variable">$agentId</span>.<span class="string">&#x27;,\&#x27;&#x27;</span>.<span class="variable">$strAccount</span>.<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="variable">$strSuperior</span>.<span class="string">&#x27;\&#x27;,&#x27;</span>.<span class="variable">$iPageIndex</span>.<span class="string">&#x27;,&#x27;</span>.<span class="variable">$pagesize</span>.<span class="string">&#x27;,@TotalCount output;</span></span><br><span class="line"><span class="string">                select @AgentID as AgentID,@TotalCount as TotalCount</span></span><br><span class="line"><span class="string">                &#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (PDOException <span class="variable">$e</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>见识略薄（也可能是我的理解和使用方式不对），也希望你们在使用的过程中能有所帮助！<br>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.coding.me/2020/01/06/thinkphp%E8%B0%83%E7%94%A8sqlserver%E5%82%A8%E5%AD%98%E8%BF%87%E7%A8%8B%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E7%BB%93%E6%9E%9C%E9%9B%86/">lihengc.coding.me</a> </p></blockquote>]]></content>
    
    
    <summary type="html">thinkphp调用sqlserver储存过程返回多个结果集，thinkphp调用sqlsrv多数据库增删改查</summary>
    
    
    
    
    <category term="php" scheme="https://lihengtt.github.io/tags/php/"/>
    
    <category term="thinkphp" scheme="https://lihengtt.github.io/tags/thinkphp/"/>
    
  </entry>
  
  <entry>
    <title>php-imap</title>
    <link href="https://lihengtt.github.io/2019/12/26/php-imap/"/>
    <id>https://lihengtt.github.io/2019/12/26/php-imap/</id>
    <published>2019-12-26T09:15:48.000Z</published>
    <updated>2025-12-05T07:26:53.791Z</updated>
    
    <content type="html"><![CDATA[<p>不多bb，直接切入主题，有什么需要就用什么招！</p><span id="more"></span><p>首先安装扩展，看shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/Downloads</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://www.php.net/distributions/php-7.2.1.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gunzip php-7.2.1.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar xvf php-7.2.1.tar</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果已有了php环境的话，前面步骤直接跳过，</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> php-7.2.1/ext/imap</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mac os phpize报错的话，试试这个shell，实在不行就google</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk/usr/include/ /usr/include</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">phpize</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果使用的是linux的话 yum install -y libc-client-* 或者apt-get</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install openssl</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install imap-uw</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">请确认自己的openssl安装路径，以免发生误会</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure --with-kerberos --with-imap-ssl=/usr/local/Cellar/openssl/1.0.2r/ --with-imap=/usr/local/Cellar/imap-uw/2007f/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取扩展路径</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">php -i | grep extension_dir</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">extension_dir =&gt; /usr/lib/php/extensions/no-debug-non-zts-20160303 =&gt; /usr/lib/php/extensions/no-debug-non-zts-20160303</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sqlite3.extension_dir =&gt; no value =&gt; no value</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cp</span> modules/imap.so /usr/lib/php/extensions/no-debug-non-zts-20160303</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最后在php.ini添加扩展</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[imap]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">extension=<span class="string">&quot;imap.so&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>linux的比较简单，mac os 系统下面略坑，brew 不带imap源码包。</p><p>linux下面不用这么复杂，编译了过后直接在php.ini配置文件里面添加扩展文件即可。</p><p>##使用imap<br>我使用了一个轮子给大家推荐一下</p><figure class="highlight plaintext"><figcaption><span>log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer require php-imap/php-imap</span><br></pre></td></tr></table></figure><p>地址和安装要求自行去看看：<a href="https://github.com/barbushin/php-imap">https://github.com/barbushin/php-imap</a></p><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create PhpImap\Mailbox instance for all further actions</span></span><br><span class="line"><span class="variable">$mailbox</span> = <span class="keyword">new</span> <span class="title class_">PhpImap\Mailbox</span>(</span><br><span class="line"><span class="string">&#x27;&#123;imap.gmail.com:993/imap/ssl&#125;INBOX&#x27;</span>, <span class="comment">// IMAP server and mailbox folder</span></span><br><span class="line"><span class="string">&#x27;some@gmail.com&#x27;</span>, <span class="comment">// Username for the before configured mailbox</span></span><br><span class="line"><span class="string">&#x27;*********&#x27;</span>, <span class="comment">// Password for the before configured username</span></span><br><span class="line"><span class="keyword">__DIR__</span>, <span class="comment">// Directory, where attachments will be saved (optional)</span></span><br><span class="line"><span class="string">&#x27;UTF-8&#x27;</span> <span class="comment">// Server encoding (optional)</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// Get all emails (messages)</span></span><br><span class="line"><span class="comment">// PHP.net imap_search criteria: http://php.net/manual/en/function.imap-search.php</span></span><br><span class="line"><span class="variable">$mailsIds</span> = <span class="variable">$mailbox</span>-&gt;<span class="title function_ invoke__">searchMailbox</span>(<span class="string">&#x27;ALL&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(PhpImap\Exceptions\ConnectionException <span class="variable">$ex</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;IMAP connection failed: &quot;</span> . <span class="variable">$ex</span>;</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If $mailsIds is empty, no emails could be found</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$mailsIds</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;Mailbox is empty&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the first message</span></span><br><span class="line"><span class="comment">// If &#x27;__DIR__&#x27; was defined in the first line, it will automatically</span></span><br><span class="line"><span class="comment">// save all attachments to the specified directory</span></span><br><span class="line"><span class="variable">$mail</span> = <span class="variable">$mailbox</span>-&gt;<span class="title function_ invoke__">getMail</span>(<span class="variable">$mailsIds</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Show, if $mail has one or more attachments</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\nMail has attachments? &quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$mail</span>-&gt;<span class="title function_ invoke__">hasAttachments</span>()) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Yes\n&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;No\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print all information of $mail</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$mail</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print all attachements of $mail</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n\nAttachments:\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$mail</span>-&gt;<span class="title function_ invoke__">getAttachments</span>());</span><br></pre></td></tr></table></figure><p>邮件检索命令的话可以自行google</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mailsIds</span> = <span class="variable">$mailbox</span>-&gt;<span class="title function_ invoke__">searchMailbox</span>(<span class="string">&#x27;UNSEEN&#x27;</span>); <span class="comment">//设置读取邮件条件</span></span><br></pre></td></tr></table></figure><p>over～</p>]]></content>
    
    
    <summary type="html">php imap 收信使用,imap扩展安装</summary>
    
    
    
    
    <category term="php" scheme="https://lihengtt.github.io/tags/php/"/>
    
    <category term="imap" scheme="https://lihengtt.github.io/tags/imap/"/>
    
  </entry>
  
  <entry>
    <title>HTMLInputElement es call input change Event</title>
    <link href="https://lihengtt.github.io/2019/12/24/HTMLInputElement/"/>
    <id>https://lihengtt.github.io/2019/12/24/HTMLInputElement/</id>
    <published>2019-12-24T02:53:08.000Z</published>
    <updated>2025-12-05T07:26:53.784Z</updated>
    
    <content type="html"><![CDATA[<p>折腾了一天，是什么事件都去试了一次，最后还是google大法好</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nativeInputValueSetter = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(<span class="variable language_">window</span>.<span class="property">HTMLInputElement</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&quot;value&quot;</span>).<span class="property">set</span>;</span><br><span class="line">nativeInputValueSetter.<span class="title function_">call</span>(input, <span class="string">&#x27;react 16 value&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ev2 = <span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>, &#123; <span class="attr">bubbles</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">input.<span class="title function_">dispatchEvent</span>(ev2);</span><br></pre></td></tr></table></figure><span id="more"></span><p>With react-dom ^15.6.0 you can use simulated flag on the event object for the event to pass through</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ev = <span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;input&#x27;</span>, &#123; <span class="attr">bubbles</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">ev.<span class="property">simulated</span> = <span class="literal">true</span>;</span><br><span class="line">element.<span class="property">value</span> = <span class="string">&#x27;Something new&#x27;</span>;</span><br><span class="line">element.<span class="title function_">dispatchEvent</span>(ev);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">recat input onchange event,js触发recat input的onchange事件</summary>
    
    
    
    
    <category term="JS" scheme="https://lihengtt.github.io/tags/JS/"/>
    
    <category term="ES" scheme="https://lihengtt.github.io/tags/ES/"/>
    
    <category term="recat" scheme="https://lihengtt.github.io/tags/recat/"/>
    
  </entry>
  
  <entry>
    <title>Google Vision OCR</title>
    <link href="https://lihengtt.github.io/2019/12/19/Google-Vision-OCR/"/>
    <id>https://lihengtt.github.io/2019/12/19/Google-Vision-OCR/</id>
    <published>2019-12-19T03:21:02.000Z</published>
    <updated>2025-12-05T07:26:53.782Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Google-Vision-OCR-爬坑建议"><a href="#Google-Vision-OCR-爬坑建议" class="headerlink" title="Google Vision OCR 爬坑建议"></a>Google Vision OCR 爬坑建议</h1><p>首先安装 Google Vision</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require google/cloud-vision</span><br></pre></td></tr></table></figure><span id="more"></span><p>第一次使用的时候真的遇到的问题很多，文档是英文的，自己慢慢摸索的途中不免进行去<code>百度</code>和<code>google</code>搜索<br>但是搜索出来的结果却不尽人意，可能是搜索方式不太对哈哈～，其实使用蛮简单，因为是别人现成对轮子，只不过使用对时候坑比较多，<br>所以特别列出以下几点。</p><ol><li>身份认证(就这个身份认证我搞了2个小时)</li><li><code>$vision-&gt;image($img_path)</code> 图片如果传入url的话会抛出异常</li></ol><h3 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h3><p>进入 <a href="https://console.cloud.google.com/">https://console.cloud.google.com/</a>  在列表里面找到api与服务选择凭据，创建凭据，选择服务帐号与密钥进行创建，我选择的格式是json<br>这个就是我们需要的凭据，导出以后放进项目</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Google</span>\<span class="title">Cloud</span>\<span class="title">Vision</span>\<span class="title">VisionClient</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$vision</span> = <span class="keyword">new</span> <span class="title class_">VisionClient</span>(</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;keyFile&#x27;</span> =&gt; <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$key_path</span>), <span class="literal">true</span>)</span><br><span class="line">            ]</span><br><span class="line">        );</span><br></pre></td></tr></table></figure><p>到这里身份认证就没有问题了，还有其他的方式，可自行研究，文档太高深，说实话不太喜欢阅读。</p><h3 id="图片导入以及function选择"><a href="#图片导入以及function选择" class="headerlink" title="图片导入以及function选择"></a>图片导入以及<code>function</code>选择</h3><p>在google官方提供的文档当中是这样写的demo</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Google</span>\<span class="title">Cloud</span>\<span class="title">Vision</span>\<span class="title">VisionClient</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$vision</span> = <span class="keyword">new</span> <span class="title class_">VisionClient</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Annotate an image, detecting faces.</span></span><br><span class="line"><span class="variable">$image</span> = <span class="variable">$vision</span>-&gt;<span class="title function_ invoke__">image</span>(</span><br><span class="line">    <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;/data/family_photo.jpg&#x27;</span>, <span class="string">&#x27;r&#x27;</span>),</span><br><span class="line">    [<span class="string">&#x27;faces&#x27;</span>]</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$annotation</span> = <span class="variable">$vision</span>-&gt;<span class="title function_ invoke__">annotate</span>(<span class="variable">$image</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine if the detected faces have headwear.</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$annotation</span>-&gt;<span class="title function_ invoke__">faces</span>() <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$face</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$face</span>-&gt;<span class="title function_ invoke__">hasHeadwear</span>()) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Face <span class="subst">$key</span> has headwear.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[&#39;faces&#39;]</code>features方法是可以多传的，更具需求传入，在最后我列出了所有的features。<br>这里还存在一个问题，我的图片是url，我尝试使用<code>fopen</code>和<code>file_get_contents</code>打开一个url，但是被抛出了异常（异常没深究，太高端看不懂，咱也不敢问），<br>最后是这样成功的，并成功拿到了返回。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">api</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$vision</span> = <span class="keyword">new</span> <span class="title class_">VisionClient</span>(</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;keyFile&#x27;</span> =&gt; <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$key_path</span>), <span class="literal">true</span>)</span><br><span class="line">            ]</span><br><span class="line">        );</span><br><span class="line">        <span class="comment"># the name of the image file to annotate</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$fileName</span> = <span class="variable">$url</span>;</span><br><span class="line">        <span class="variable">$imageData</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$fileName</span>);</span><br><span class="line">        <span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Image</span>(<span class="variable">$imageData</span>, [</span><br><span class="line">            <span class="string">&#x27;TEXT_DETECTION&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$vision</span>-&gt;<span class="title function_ invoke__">annotate</span>(<span class="variable">$image</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$text_array</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">info</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$text_array</span>[<span class="string">&#x27;textAnnotations&#x27;</span>])&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$text_array</span>[<span class="string">&#x27;textAnnotations&#x27;</span>][<span class="string">&#x27;0&#x27;</span>][<span class="string">&#x27;description&#x27;</span>]))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$text_array</span>[<span class="string">&#x27;textAnnotations&#x27;</span>][<span class="string">&#x27;0&#x27;</span>][<span class="string">&#x27;description&#x27;</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>##features</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> [</span><br><span class="line">    <span class="string">&#x27;faces&#x27;</span>,          <span class="comment">// Corresponds to `FACE_DETECTION`</span></span><br><span class="line">    <span class="string">&#x27;landmarks&#x27;</span>,      <span class="comment">// Corresponds to `LANDMARK_DETECTION`</span></span><br><span class="line">    <span class="string">&#x27;logos&#x27;</span>,          <span class="comment">// Corresponds to `LOGO_DETECTION`</span></span><br><span class="line">    <span class="string">&#x27;labels&#x27;</span>,         <span class="comment">// Corresponds to `LABEL_DETECTION`</span></span><br><span class="line">    <span class="string">&#x27;text&#x27;</span>,           <span class="comment">// Corresponds to `TEXT_DETECTION`,</span></span><br><span class="line">    <span class="string">&#x27;document&#x27;</span>,       <span class="comment">// Corresponds to `DOCUMENT_TEXT_DETECTION`</span></span><br><span class="line">    <span class="string">&#x27;safeSearch&#x27;</span>,     <span class="comment">// Corresponds to `SAFE_SEARCH_DETECTION`</span></span><br><span class="line">    <span class="string">&#x27;imageProperties&#x27;</span>,<span class="comment">// Corresponds to `IMAGE_PROPERTIES`</span></span><br><span class="line">    <span class="string">&#x27;crop&#x27;</span>,           <span class="comment">// Corresponds to `CROP_HINTS`</span></span><br><span class="line">    <span class="string">&#x27;web&#x27;</span>             <span class="comment">// Corresponds to `WEB_DETECTION`</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>以上初次使用的坑，见识略薄（也可能是我的理解和使用方式不对），也希望你们在使用的过程中能有所帮助！</p></blockquote>]]></content>
    
    
    <summary type="html">google 图片识别使用的一些坑和建议，Google OCR 使用</summary>
    
    
    
    
    <category term="php" scheme="https://lihengtt.github.io/tags/php/"/>
    
    <category term="Google Vision" scheme="https://lihengtt.github.io/tags/Google-Vision/"/>
    
    <category term="OCR" scheme="https://lihengtt.github.io/tags/OCR/"/>
    
  </entry>
  
  <entry>
    <title>H5网页唤醒app,判断app安装</title>
    <link href="https://lihengtt.github.io/2019/09/24/H5%E7%BD%91%E9%A1%B5%E5%94%A4%E9%86%92app-%E5%88%A4%E6%96%ADapp%E5%AE%89%E8%A3%85/"/>
    <id>https://lihengtt.github.io/2019/09/24/H5%E7%BD%91%E9%A1%B5%E5%94%A4%E9%86%92app-%E5%88%A4%E6%96%ADapp%E5%AE%89%E8%A3%85/</id>
    <published>2019-09-24T03:50:45.000Z</published>
    <updated>2025-12-05T07:26:53.783Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>在阅读本文之前你首先应该对js有基本对掌握，并且对Scheme，intent有一定的理解。更多的是代码</p></blockquote><span id="more"></span><h2 id="callapp-lib"><a href="#callapp-lib" class="headerlink" title="callapp-lib"></a><a href="https://www.npmjs.com/package/callapp-lib">callapp-lib</a></h2><p>这里利用了别人的库，可以省略部分代码，<code>callapp-lib</code>可以直接唤醒app，以及唤醒失败的<code>callback</code>，但是你得传入Scheme。</p><p><code>callapp-lib</code>库可能有一点问题，我也没有理解透彻，它并不给你提供唤醒成功<code>callback</code>的功能，所以需要我们自己补足。<br>文档：<a href="https://www.npmjs.com/package/callapp-lib">callapp-lib</a></p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">CallApp</span> <span class="keyword">from</span> <span class="string">&#x27;callapp-lib&#x27;</span></span><br><span class="line"><span class="keyword">const</span> option = &#123;</span><br><span class="line">    <span class="attr">scheme</span>: &#123;</span><br><span class="line">        <span class="attr">protocol</span>: <span class="string">&#x27;itms-beta&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">outChain</span>: &#123;</span><br><span class="line">        <span class="attr">protocol</span>: <span class="string">&#x27;itms-beta&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">appstore</span>: <span class="string">&#x27;http://www.apple.com&#x27;</span>,</span><br><span class="line">    <span class="attr">yingyongbao</span>: <span class="string">&#x27;http://www.zhihu.com&#x27;</span>,</span><br><span class="line">    <span class="attr">fallback</span>: <span class="string">&#x27;https://www.baidu.com&#x27;</span>,</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">3000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> lib = <span class="keyword">new</span> <span class="title class_">CallApp</span>(option);</span><br><span class="line"><span class="keyword">const</span> callButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#call-button&#x27;</span>);</span><br><span class="line">callButton.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    vm.<span class="property">is_show</span> = <span class="number">1</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$toast</span>.<span class="title function_">loading</span>(&#123;</span><br><span class="line">        <span class="attr">mask</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;加载中...&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    lib.<span class="title function_">open</span>(&#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/text&#x27;</span>,</span><br><span class="line">        <span class="attr">callback</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            vm.<span class="property">is_show</span> = <span class="number">0</span></span><br><span class="line">            self.<span class="property">$toast</span>.<span class="title function_">fail</span>(<span class="string">&#x27;打开TestFlight失败,请先下载支持软件TestFlight&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="检测网页是否被切到后台运行，并监听该事件"><a href="#检测网页是否被切到后台运行，并监听该事件" class="headerlink" title="检测网页是否被切到后台运行，并监听该事件"></a>检测网页是否被切到后台运行，并监听该事件</h2><p><code>is_show</code> 是为了阻止重复加载</p><figure class="highlight javascript"><figcaption><span>1.6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> hidden, state, visibilityChange;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">document</span>.<span class="property">hidden</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    hidden = <span class="string">&quot;hidden&quot;</span>;</span><br><span class="line">    visibilityChange = <span class="string">&quot;visibilitychange&quot;</span>;</span><br><span class="line">    state = <span class="string">&quot;visibilityState&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">document</span>.<span class="property">mozHidden</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    hidden = <span class="string">&quot;mozHidden&quot;</span>;</span><br><span class="line">    visibilityChange = <span class="string">&quot;mozvisibilitychange&quot;</span>;</span><br><span class="line">    state = <span class="string">&quot;mozVisibilityState&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">document</span>.<span class="property">msHidden</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    hidden = <span class="string">&quot;msHidden&quot;</span>;</span><br><span class="line">    visibilityChange = <span class="string">&quot;msvisibilitychange&quot;</span>;</span><br><span class="line">    state = <span class="string">&quot;msVisibilityState&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">document</span>.<span class="property">webkitHidden</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    hidden = <span class="string">&quot;webkitHidden&quot;</span>;</span><br><span class="line">    visibilityChange = <span class="string">&quot;webkitvisibilitychange&quot;</span>;</span><br><span class="line">    state = <span class="string">&quot;webkitVisibilityState&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(visibilityChange, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// eslint-disable-next-line</span></span><br><span class="line">  <span class="comment">//这里判断不要重复下载</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">is_show</span> == <span class="number">1</span>) &#123;</span><br><span class="line">      vm.<span class="property">is_show</span> = <span class="number">0</span></span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&#x27;正在下载&#x27;</span>);</span><br><span class="line">      location.<span class="title function_">reload</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>原创不易，转载请附上原文出处链接,谢谢<br>原文链接：<a href="https://lihengc.github.io/2019/09/24/H5%E7%BD%91%E9%A1%B5%E5%94%A4%E9%86%92app-%E5%88%A4%E6%96%ADapp%E5%AE%89%E8%A3%85/">https://lihengc.github.io/2019/09/24/H5%E7%BD%91%E9%A1%B5%E5%94%A4%E9%86%92app-%E5%88%A4%E6%96%ADapp%E5%AE%89%E8%A3%85/</a></p>]]></content>
    
    
    <summary type="html">H5网页唤醒app,判断app安装,判断app是否安装,Scheme,intent,判断唤醒app是否成功,callapp-lib</summary>
    
    
    
    
    <category term="H5网页唤醒app" scheme="https://lihengtt.github.io/tags/H5%E7%BD%91%E9%A1%B5%E5%94%A4%E9%86%92app/"/>
    
    <category term="intent" scheme="https://lihengtt.github.io/tags/intent/"/>
    
    <category term="Scheme" scheme="https://lihengtt.github.io/tags/Scheme/"/>
    
  </entry>
  
  <entry>
    <title>Mysql主从复制配置</title>
    <link href="https://lihengtt.github.io/2019/09/09/Mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/"/>
    <id>https://lihengtt.github.io/2019/09/09/Mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE/</id>
    <published>2019-09-09T05:48:18.000Z</published>
    <updated>2025-12-05T07:26:53.787Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>a为主库，b为从库！</p></blockquote><h3 id="mysql主从复制介绍"><a href="#mysql主从复制介绍" class="headerlink" title="mysql主从复制介绍"></a>mysql主从复制介绍</h3><span id="more"></span><p>mysql主从复制，发生在a,b数据库环境下，a为宿主机，b为奴隶机。在a里面写入数据，b也会自动写入数据，从而达到数据一致。</p><h4 id="主从原理及过程"><a href="#主从原理及过程" class="headerlink" title="主从原理及过程"></a>主从原理及过程</h4><p>mysql主从是基于binlog，主机上需要开启binlog才能实现主从。</p><p>过程及其简单<br><br /></p><ul><li><p>a将所有的写操作记录在binlog日志中，并生成log dump线程 将binlog日志传给b库的I&#x2F;O线程</p></li><li><p>b库生成两个线程，一个是I&#x2F;O线程，另一个是SQL线程</p></li><li><p>I&#x2F;O线程去请求主库的binlog日志，并将binlog日志中的文件写入relay log（中继日志）中</p></li><li><p>SQL线程会读取relay loy中的内容，并解析成具体的操作，来实现主从的操作一致，达到最终数据一致的目的</p></li></ul><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ul><li>实时灾备，用于故障切换</li><li>读写分离，提供查询服务</li><li>备份，避免影响业务</li></ul><h3 id="主从复制配置步骤"><a href="#主从复制配置步骤" class="headerlink" title="主从复制配置步骤"></a>主从复制配置步骤</h3><ol><li><p>确保b数据库与a库里的数据一致</p></li><li><p>在a数据库里创建一个同步账户授权给b数据库使用</p></li><li><p>配置a库（修改数据库配置文件）</p></li><li><p>配置b库 (修改数据库配置文件)</p></li></ol><h3 id="下面是我自己测试所用到的环境以及整个过程"><a href="#下面是我自己测试所用到的环境以及整个过程" class="headerlink" title="下面是我自己测试所用到的环境以及整个过程"></a>下面是我自己测试所用到的环境以及整个过程</h3><blockquote><p>因为我使用的是docker环境直接部署的镜像数据库所有没有操作系统版本,并且我省略掉略docker的一些过程，可以自行琢磨。</p></blockquote><table><thead><tr><th>数据库角色</th><th>ip</th><th>数据库版本</th></tr></thead><tbody><tr><td>a(主数据库)</td><td>172.17.0.2</td><td>5.6</td></tr><tr><td>b(从数据库)</td><td>172.17.0.3</td><td>5.6</td></tr></tbody></table><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>1.安装docker，拉取镜像，运行两个数据库环境,并初始化数据库(如有需要可以挂载目录，以及建立软连)</p><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">//建立一个新库及表并且插入了几条数据</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database testbase;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use testbase;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create table tom (<span class="built_in">id</span> int not null,name varchar(100)not null ,age tinyint);</span></span><br><span class="line">Query OK, 0 rows affected (11.83 sec)</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert tom (<span class="built_in">id</span>,name,age) values(1,<span class="string">&#x27;zhangshan&#x27;</span>,20),(2,<span class="string">&#x27;wangwu&#x27;</span>,7),(3,<span class="string">&#x27;lisi&#x27;</span>,23);</span></span><br><span class="line">Query OK, 3 rows affected (0.07 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from tom;</span></span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   20 |</span><br><span class="line">|  2 | wangwu    |    7 |</span><br><span class="line">|  3 | lisi      |   23 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line">备份主库</span><br><span class="line">备份主库时需要另开一个终端，给数据库上读锁，避免在备份期间有其他人在写入导致数据同步的不一致</span><br><span class="line">//第一个终端</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush tables with <span class="built_in">read</span> lock;</span></span><br><span class="line">Query OK, 0 rows affected (0.76 sec)</span><br><span class="line"></span><br><span class="line">//第二个终端 备份完毕直接退出第一个终端就解锁</span><br><span class="line">root@ca05ed1d3a86:/#  mysqldump -uroot -proot --all-databases &gt; /opt/all-20190909.sql</span><br><span class="line"></span><br><span class="line">//现在需要把备份的sql文件放到从库环境当中去，因为我使用的是docker所以比较麻烦，过程我就省略了</span><br><span class="line"></span><br><span class="line">//进入从库环境 导入数据库</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">source</span> /opt/all-20190909.sql</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| testbase           |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from tom;</span></span><br><span class="line">+----+-----------+------+</span><br><span class="line">| id | name      | age  |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">|  1 | zhangshan |   20 |</span><br><span class="line">|  2 | wangwu    |    7 |</span><br><span class="line">|  3 | lisi      |   23 |</span><br><span class="line">+----+-----------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line">//确认和主库一致 退出从库</span><br><span class="line">//在主数据库创建一个同步账户授权给从数据使用</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create user <span class="string">&#x27;Slave&#x27;</span>@<span class="string">&#x27;172.17.0.3&#x27;</span> identified by <span class="string">&#x27;root&#x27;</span>;</span></span><br><span class="line">Query OK, 0 rows affected (5.50 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to <span class="string">&#x27;Slave&#x27;</span>@<span class="string">&#x27;172.17.0.3&#x27;</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush privileges;</span></span><br><span class="line">Query OK, 0 rows affected (0.09 sec)</span><br><span class="line"></span><br><span class="line">//修改主库配置文件</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">quit</span></span><br><span class="line">Bye</span><br><span class="line">root@ca05ed1d3a86:/# vi /etc/mysql/mysql.conf.d/mysqld.cnf </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This program is free software; you can redistribute it and/or modify</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the Free Software Foundation; version 2 of the License.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This program is distributed in the hope that it will be useful,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">GNU General Public License <span class="keyword">for</span> more details.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You should have received a copy of the GNU General Public License</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">along with this program; <span class="keyword">if</span> not, write to the Free Software</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The MySQL  Server configuration file.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># For explanations see</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://dev.mysql.com/doc/mysql/en/server-system-variables.html</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">pid-file= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket= /var/run/mysqld/mysqld.sock</span><br><span class="line">datadir= /var/lib/mysql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">log-error= /var/log/mysql/error.log</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">add 此处为新加的</span></span><br><span class="line">log-bin=mysql-bin //启用binlog日志</span><br><span class="line">server-id=1 //主数据库服务器唯一标识符 主的必须必从大</span><br><span class="line">log-error=/var/log/mysql/error.log</span><br><span class="line"></span><br><span class="line">//重启主库</span><br><span class="line">root@ca05ed1d3a86:/# exit</span><br><span class="line">LeedeiMac:Desktop lee$ docker restart ts_mysql</span><br><span class="line"></span><br><span class="line">查看主库的状态</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master status;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000002</span><br><span class="line">         Position: 588</span><br><span class="line">     Binlog_Do_DB: </span><br><span class="line"> Binlog_Ignore_DB: </span><br><span class="line">Executed_Gtid_Set: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//下面接着配置从库</span><br><span class="line">root@1711bd0b98b0:/# vi /etc/mysql/mysql.conf.d/mysqld.cnf </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copyright (c) 2014, 2016, Oracle and/or its affiliates. All rights reserved.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This program is free software; you can redistribute it and/or modify</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the Free Software Foundation; version 2 of the License.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This program is distributed in the hope that it will be useful,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">GNU General Public License <span class="keyword">for</span> more details.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># You should have received a copy of the GNU General Public License</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">along with this program; <span class="keyword">if</span> not, write to the Free Software</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The MySQL  Server configuration file.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># For explanations see</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://dev.mysql.com/doc/mysql/en/server-system-variables.html</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">pid-file= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket= /var/run/mysqld/mysqld.sock</span><br><span class="line">datadir= /var/lib/mysql</span><br><span class="line">log-error= /var/log/mysql/error.log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">add 此处为新加的</span></span><br><span class="line">server-id=2 //设置从库的唯一标识符 从的必须比主小</span><br><span class="line">relay-log=mysql-relay-bin //启用中继日志relay log</span><br><span class="line"></span><br><span class="line">//配置完毕后记得重启</span><br><span class="line">//配置并启动主从复制</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">change master to</span></span><br><span class="line">    -&gt; master_host=&#x27;172.17.0.2&#x27;,</span><br><span class="line">    -&gt; master_user=&#x27;Slave&#x27;,</span><br><span class="line">    -&gt; master_password=&#x27;root&#x27;,</span><br><span class="line">    -&gt; master_log_file=&#x27;mysql-bin.000002&#x27;,</span><br><span class="line">    -&gt; master_log_pos=588;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.28 sec)</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">start slave</span></span><br><span class="line">//查看从服务器状态</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.17.0.2</span><br><span class="line">                  Master_User: Slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 822</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 985</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes  //IO线程必须是YES</span><br><span class="line">            Slave_SQL_Running: Yes  //SQL线程必须是YES</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 822</span><br><span class="line">              Relay_Log_Space: 1158</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: ebbfdd47-b8f4-11e9-98ee-0242ac110002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">//到这里就成功了，我也就不做验证了</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="如果有遇见io线程和sql线程开启不了的，原因太多，请自行-goole。"><a href="#如果有遇见io线程和sql线程开启不了的，原因太多，请自行-goole。" class="headerlink" title="如果有遇见io线程和sql线程开启不了的，原因太多，请自行 goole。"></a>如果有遇见io线程和sql线程开启不了的，原因太多，请自行 <a href="https://www.google.com/">goole</a>。</h4><blockquote><p>码字不易～</p></blockquote>]]></content>
    
    
    <summary type="html">mysql简单主从复制配置详解</summary>
    
    
    
    
    <category term="mysql" scheme="https://lihengtt.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>slow log慢日志分析,phpfpm性能分析</title>
    <link href="https://lihengtt.github.io/2019/08/15/%E6%85%A2%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90-phpfpm%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    <id>https://lihengtt.github.io/2019/08/15/%E6%85%A2%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90-phpfpm%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/</id>
    <published>2019-08-15T03:23:16.000Z</published>
    <updated>2025-12-05T07:15:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>我们都知道mysql是有slow query log，根据慢查询日志，我们可以知道那些sql语句有性能问题<br>当然php也是具有慢日志的，如果你使用php-fpm来管理php的话，你可以通过如下选项开启。</p><span id="more"></span><h4 id="PHP-5-3-3-之前设置如下："><a href="#PHP-5-3-3-之前设置如下：" class="headerlink" title="PHP 5.3.3 之前设置如下："></a>PHP 5.3.3 之前设置如下：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;value name=&quot;request_slowlog_timeout&quot;&gt;5s&lt;/value&gt;</span><br><span class="line">&lt;value name=&quot;slowlog&quot;&gt;logs/php-fpm-slowlog.log&lt;/value&gt;</span><br></pre></td></tr></table></figure><h4 id="PHP-5-3-3-之后设置以下如下：php-fpm-conf"><a href="#PHP-5-3-3-之后设置以下如下：php-fpm-conf" class="headerlink" title="PHP 5.3.3 之后设置以下如下：php-fpm.conf"></a>PHP 5.3.3 之后设置以下如下：php-fpm.conf</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request_slowlog_timeout = 5s</span><br><span class="line">slowlog = /usr/local/php/log/php-fpm-slowlog.log</span><br></pre></td></tr></table></figure><p>说明:</p><p>request_slowlog_timeout 是脚本超过多长时间 就可以记录到日志文件</p><p>slowlog 是日志文件的路径</p><h4 id="开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息："><a href="#开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息：" class="headerlink" title="开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息："></a>开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息：</h4><figure class="highlight plaintext"><figcaption><span>log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[15-Aug-2019 14:50:19] [pool www] pid 18575</span><br><span class="line">script_filename = /home/web/htdocs/xxxx/test/tt.php</span><br><span class="line">[0x0000000003a00dc8] curl_exec() /home/web/htdocs/xxxx/test/tt.php:2</span><br><span class="line">[0x0000000003a00cd0] exfilter_curl_get() /home/web/htdocs/xxxx/test/tt.php:6</span><br></pre></td></tr></table></figure><h4 id="日志说明："><a href="#日志说明：" class="headerlink" title="日志说明："></a>日志说明：</h4><ol><li>script_filename 是入口文件</li><li>curl_exec() ： 说明是执行这个方法的时候超过执行时间的。</li><li>exfilter_curl_get() ：说明调用curl_exec()的方法是exfilter_curl_get() 。</li><li>每行冒号后面的数字是行号。</li></ol><p>开启后，在错误日志文件中也有相关记录。如下：</p><figure class="highlight plaintext"><figcaption><span>log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[15-Aug-2019 15:55:37] WARNING: [pool www] child 18575, script &#x27;/home/web/htdocs/xxxxlong/test/tt.php&#x27; (request: &quot;GET /test/tt.php&quot;) executing too slow (1.006222 sec), logging</span><br><span class="line">[15-Aug-2019 15:55:37] NOTICE: child 18575 stopped for tracing</span><br><span class="line">[15-Aug-2019 15:55:37] NOTICE: about to trace 18575</span><br><span class="line">[15-Aug-2019 15:55:37] NOTICE: finished trace of 18575</span><br></pre></td></tr></table></figure><h3 id="Docker-php-fpm-慢查询-failed-to-ptrace-Operation-not-permitted解决方案"><a href="#Docker-php-fpm-慢查询-failed-to-ptrace-Operation-not-permitted解决方案" class="headerlink" title="Docker php-fpm 慢查询 failed to ptrace Operation not permitted解决方案"></a>Docker php-fpm 慢查询 failed to ptrace Operation not permitted解决方案</h3><p>宿主机的服务慢查询是正常的，但是到了Docker中的php-fpm服务，触发慢查询后，会输出类似报错：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[15-Aug-2019 15:59:17] ERROR: failed to ptrace(ATTACH) child 5118: Operation not permitted (1)</span><br><span class="line">[15-Aug-2019 15:59:17] WARNING: [pool www] child 5118, script &#x27;/www/index.php&#x27; (request: &quot;GET /index.php&quot;) executing too slow (1.021099 sec), logging</span><br></pre></td></tr></table></figure><p>开始没想到的Docker容器权限问题，后来搜了下，在serverfault找到了解决方案：<br>容器启动时，加入参数：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--cap-<span class="keyword">add</span><span class="language-bash"> SYS_PTRACE</span></span><br></pre></td></tr></table></figure><p>解决方案来自：<a href="https://serverfault.com/questions/704007/php-slowlog-causing-ptrace-error-in-docker-container/706982#706982">https://serverfault.com/questions/704007/php-slowlog-causing-ptrace-error-in-docker-container/706982#706982</a></p><hr><ul><li>系统日志：记录系统相关信息：<a href="http://blog.csdn.net/ty_hf/article/details/55511624">http://blog.csdn.net/ty_hf/article/details/55511624</a></li><li>apache访问日志与错误日志：<a href="http://blog.csdn.net/ty_hf/article/details/55504719">http://blog.csdn.net/ty_hf/article/details/55504719</a></li><li>nginx访问日志与错误日志：<a href="http://blog.csdn.net/ty_hf/article/details/55518070">http://blog.csdn.net/ty_hf/article/details/55518070</a></li><li>php-fpm慢日志：检测执行较慢的PHP脚本：<a href="http://blog.csdn.net/ty_hf/article/details/55504172">http://blog.csdn.net/ty_hf/article/details/55504172</a></li><li>php错误日志：检测php运行时或用户自记录错误日志：<a href="http://blog.csdn.net/ty_hf/article/details/55505262">http://blog.csdn.net/ty_hf/article/details/55505262</a></li><li>mysql慢日志：记录mysql服务器中影响性能的SQL：<a href="http://blog.csdn.net/ty_hf/article/details/55504172">http://blog.csdn.net/ty_hf/article/details/55504172</a></li></ul>]]></content>
    
    
    <summary type="html">php-fpm slow log 慢日志分析,phpfpm性能分析</summary>
    
    
    
    
    <category term="php" scheme="https://lihengtt.github.io/tags/php/"/>
    
    <category term="php-fpm" scheme="https://lihengtt.github.io/tags/php-fpm/"/>
    
  </entry>
  
  <entry>
    <title>php-fpm安装redis</title>
    <link href="https://lihengtt.github.io/2019/08/10/php-fpm%E5%AE%89%E8%A3%85redis/"/>
    <id>https://lihengtt.github.io/2019/08/10/php-fpm%E5%AE%89%E8%A3%85redis/</id>
    <published>2019-08-10T06:38:19.000Z</published>
    <updated>2025-12-05T07:15:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>一顿操作猛如虎</p><span id="more"></span><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it ts_phpfpm /bin/bash</span><br><span class="line">curl -L -o /tmp/redis.tar.gz https://github.com/phpredis/phpredis/archive/<span class="number">3.1</span>.<span class="number">3</span>.tar.gz</span><br><span class="line"></span><br><span class="line">tar xfz /tmp/redis.tar.gz</span><br><span class="line"></span><br><span class="line">rm -r /tmp/redis.tar.gz</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/src/php/ext</span><br><span class="line"></span><br><span class="line">mv phpredis-<span class="number">3.1</span>.<span class="number">3</span> /usr/src/php/ext/redis</span><br><span class="line"></span><br><span class="line">docker-php-ext-install redis</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">php-fpm安装redis扩展</summary>
    
    
    
    
    <category term="php" scheme="https://lihengtt.github.io/tags/php/"/>
    
    <category term="docker" scheme="https://lihengtt.github.io/tags/docker/"/>
    
    <category term="redis" scheme="https://lihengtt.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>PHP编写守护进程</title>
    <link href="https://lihengtt.github.io/2019/08/05/PHP%E7%BC%96%E5%86%99%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/"/>
    <id>https://lihengtt.github.io/2019/08/05/PHP%E7%BC%96%E5%86%99%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/</id>
    <published>2019-08-05T03:41:44.000Z</published>
    <updated>2025-12-05T07:26:53.789Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>进程根据状态可以分为三种进程，守护进程，僵尸进程，孤儿进程。今天我们着重来分析下守护进程。</p><h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3>  <hr />  #### 简介  <span id="more"></span>  守护进程 (daemon) 是一类在后台运行的特殊进程，用于执行特定的系统任务。很多守护进程在系统引导的时候启动，并且一直运行直到系统关闭。另一些只在需要的时候才启动，完成任务后就自动结束。  <h4 id="创建步骤"><a href="#创建步骤" class="headerlink" title="创建步骤"></a>创建步骤</h4></li></ul><p>####1. 创建子进程，终止父进程<br>    由于守护进程是脱离控制终端的，因此首先创建子进程，终止父进程，使得程序在 shell 终端里造成一个已经运行完毕的假象。<br>    之后所有的工作都在子进程中完成，而用户在 shell 终端里则可以执行其他的命令，从而使得程序以僵尸进程形式运行，在形式 I 上做到了与控制终端的脱离。<br>####2. 在子进程中创建新会话<br>    这个步骤是创建守护进程中最重要的一步，在这里使用的是系统函数 setsid。<br>    setsid 函数用于创建一个新的会话，并担任该会话组的组长。<br>    调用 setsid 的三个作用：让进程摆脱原会话的控制、让进程摆脱原进程组的控制和让进程摆脱原控制终端的控制。<br>    在调用 fork 函数时，子进程全盘拷贝父进程的会话期 (session，是一个或多个进程组的集合)、进程组、控制终端等，虽然父进程退出了，但原先的会话期、进程组、控制终端等并没有改变，因此，那还不是真正意义上使两者独立开来。<br>    setsid 函数能够使进程完全独立出来，从而脱离所有其他进程的控制。</p><p>####3. 改变工作目录<br>    使用fork创建的子进程会继承父进程的当前工作目录。<br>    由于子进程运行的过程中，当前目录所在的文件系统不能被卸载，因此，我们需要把当前工作目录换成其他路径，如<code>/</code>或<code>/tmp</code>等。<br>    改变工作目录的常见函数是chdir。<br>####4. 重设文件创建掩码<br>    文件创建掩码是指屏蔽掉文件创建时的对应位。<br>    由于使用 fork 函数新建的子进程继承了父进程的文件创建掩码，这就给该子进程使用文件带来了诸多的麻烦。<br>    因此，把文件创建掩码设置为 0，可以大大增强该守护进程的灵活性。<br>    设置文件创建掩码的函数是 umask，通常的使用方法为 umask (0)。<br>####5. 关闭文件描述符<br>    用 fork 新建的子进程会从父进程那里继承一些已经打开了的文件。<br>    这些被打开的文件可能永远不会被守护进程读或写，但它们一样消耗系统资源，可能导致所在的文件系统无法卸载。<br>    在上面的第二步之后，守护进程已经与所属的控制终端失去了联系。<br>    因此从终端输入的字符不可能达到守护进程，守护进程中用常规方法（如printf）输出的字符也不可能在终端上显示出来。<br>    所以，文件描述符为0、1和2 的3个文件（常说的输入、输出和报错）已经失去了存在的价值，也应被关闭。</p><p>##code：</p><pre><code class="language-php">&lt;?phpclass Deamon{    protected $_pidFile;    public function __construct()    {        $this-&gt;_pidFile = &#39;/var/www/html/queue/public/pid.log&#39;;        $this-&gt;_checkPcntl();    }    /**     * 创建守护进程核心函数     * @return string|void     */    private function _demonize()    {        if (php_sapi_name() != &#39;cli&#39;) {            die(&#39;Should run in CLI&#39;);        }        //创建子进程        $pid = pcntl_fork();        if ($pid == -1) {            return &#39;fork faile&#39;;        } elseif ($pid) {            //终止父进程            exit(&#39;parent process&#39;);        }        //在子进程中创建新的会话        if (posix_setsid() === -1) {            die(&#39;Could not detach&#39;);        }        //改变工作目录        chdir(&#39;/&#39;);        //重设文件创建的掩码        umask(0);        $fp = fopen($this-&gt;_pidFile, &#39;w&#39;) or die(&quot;Can&#39;t create pid file&quot;);        //把当前进程的id写入到文件中        fwrite($fp, posix_getpid());        fclose($fp);        //关闭文件描述符        fclose(STDIN);        fclose(STDOUT);        fclose(STDERR);        //运行守护进程的逻辑        $this-&gt;job();        return;    }    /**     * 守护进程的任务     */    private function job()    {        //TODO 你的守护经常需要执行的任务        while (true) {            file_put_contents(&#39;/var/www/html/queue/public/job.log&#39;, &#39;job&#39; . PHP_EOL, FILE_APPEND);            sleep(5);        }    }    /**     * 获取守护进程的id     * @return int     */    private function _getPid()    {        //判断存放守护进程id的文件是否存在        if (!file_exists($this-&gt;_pidFile)) {            return 0;        }        $pid = intval(file_get_contents($this-&gt;_pidFile));        if (posix_kill($pid, SIG_DFL)) {//判断该进程是否正常运行中            return $pid;        } else {            unlink($this-&gt;_pidFile);            return 0;        }    }    /**     * 判断pcntl拓展     */    private function _checkPcntl()    {        !function_exists(&#39;pcntl_signal&#39;) &amp;&amp; die(&#39;Error:Need PHP Pcntl extension!&#39;);    }    private function _message($message)    {        printf(&quot;%s  %d %d  %s&quot; . PHP_EOL, date(&quot;Y-m-d H:i:s&quot;), posix_getpid(), posix_getppid(), $message);    }    /**     * 开启守护进程     */    private function start()    {        if ($this-&gt;_getPid() &gt; 0) {            $this-&gt;_message(&#39;Running&#39;);        } else {            $this-&gt;_demonize();            $this-&gt;_message(&#39;Start&#39;);        }    }    /**     * 停止守护进程     */    private function stop()    {        $pid = $this-&gt;_getPid();        if ($pid &gt; 0) {            //通过向进程id发送终止信号来停止进程            posix_kill($pid, SIGTERM);            unlink($this-&gt;_pidFile);            echo &#39;Stoped&#39; . PHP_EOL;        } else {            echo &quot;Not Running&quot; . PHP_EOL;        }    }    private function status()    {        if ($this-&gt;_getPid() &gt; 0) {            $this-&gt;_message(&#39;Is Running&#39;);        } else {            echo &#39;Not Running&#39; . PHP_EOL;        }    }    public function run($argv)    {        $param = is_array($argv) &amp;&amp; count($argv) == 2 ? $argv[1] : null;        switch ($param) {            case &#39;start&#39;:                $this-&gt;start();                break;            case &#39;stop&#39;:                $this-&gt;stop();                break;            case &#39;status&#39;:                $this-&gt;status();                break;            default:                echo &quot;Argv start|stop|status &quot; . PHP_EOL;                break;        }    }}$deamon = new \Deamon();$deamon-&gt;run($argv);</code></pre><h3 id="运行方式"><a href="#运行方式" class="headerlink" title="运行方式"></a>运行方式</h3><ul><li>开启守护进程：php test.php start</li><li>停止守护进程：php test.php stop</li><li>查看守护进程的状态：php test.php status</li></ul>]]></content>
    
    
    <summary type="html">PHP 创建守护进程</summary>
    
    
    
    
    <category term="PHP" scheme="https://lihengtt.github.io/tags/PHP/"/>
    
    <category term="swoole" scheme="https://lihengtt.github.io/tags/swoole/"/>
    
  </entry>
  
</feed>
