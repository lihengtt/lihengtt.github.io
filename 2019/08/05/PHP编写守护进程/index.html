<!-- @format -->



<!DOCTYPE html>
<html lang="en">
<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!--360 使用 Google Chrome Frame-->
  <meta name="renderer" content="webkit">
  <!--百度禁止转码-->
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <!--Description-->
  
  <meta name="description" content="PHP 创建守护进程">
  
  <meta name="google-site-verification" content="J4gssmXGNI9-DfJ9w52mL5KFPlRCYvySveEN0RJFZHU" />
  <!--Author-->
  
  <meta name="author" content="李恒">
  
  <!--Open Graph Title-->
  <meta property="og:title" content="PHP编写守护进程" />
  <!--Open Graph Description-->
  <meta property="og:description" content="PHP 创建守护进程" />
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="Harthali" />
  <!--Type page-->
  
  <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  
  <meta property="og:image" content="/null" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Title -->
  
  <title>PHP编写守护进程 - Harthali</title>
  <!-- 添加到主屏后的标题（iOS 6 新增） -->
  <meta name="apple-mobile-web-app-title" content="Harthali">
  <!-- 是否启用 WebApp 全屏模式 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-startup-image" href="/assets/ splash-assets.png" media="(max-device-width: 700px)">
  <!-- 禁止数字识自动别为电话号码 -->
  <meta name="format-detection" content="telephone=no" />
  <link rel="shortcut icon" href="/null">
  <!--Apple iOS Safari ICON-->
  <link rel="apple-touch-icon" sizes="57x57" href="" />
  <link rel="apple-touch-icon" sizes="72x72" href="" />
  <link rel="apple-touch-icon" sizes="114x114" href="" />
  <link rel="apple-touch-icon" sizes="144x144" href="" />
  <!-- 添加 RSS 订阅 -->
  <link rel="alternate" type="application/rss+xml" title="Harthali" href="/atom.xml" />
  <!-- uc强制竖屏 -->
  <meta name="screen-orientation" content="portrait">
  <!-- QQ强制竖屏 -->
  <meta name="x5-orientation" content="portrait">
  <!-- UC强制全屏 -->
  <meta name="full-screen" content="yes">
  <!-- QQ强制全屏 -->
  <meta name="x5-fullscreen" content="true">
  <!-- UC应用模式 -->
  <meta name="browsermode" content="application">
  <!-- QQ应用模式 -->
  <meta name="x5-page-mode" content="app">
  <!-- https://material.io/resources/icons/?style=outline -->
  
  <script src="https://lf1-cdn-tos.bytegoofy.com/obj/iconpark/icons_20213_18.4a5f87dae8e6f9e336b9ad6fa00f8e8f.js"></script>
  
  
<style>
  .itp-gallery-title,
  .itp-gallery-subtitle,
  .itp-post-title,
  .itp-post-entry-title,
  .itp-post-entry-subtitle,
  .itp-mag-logo,
  .itp-index-title,
  .itp-post-entry-moment,
  .itp-header-actions-menu {
    font-family: ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
  }

  .itp-header-title,
  .itp-m3-post-entry-info .title,
  .itp-header-actions,
  .itp-cover-title,
  .itp-cover-subtitle,
  .itp-post-subtitle,
  .itp-post-entry-title,
  .itp-m3-cover-subtitle,
  .itp-m3-cover-title,
  .itp-gallery-info .title,
  .footer-info {
    font-family: ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
  }

  .article,
  .itp-post-entry-excerpt {
    font-family: 'SF UI Display', '.PingFang SC', 'PingFang SC', 'Neue Haas Grotesk Text Pro', 'Arial Nova', 'Segoe UI', 'Microsoft YaHei', 'Microsoft JhengHei', 'Helvetica Neue', 'Source Han Sans SC', 'Noto Sans CJK SC', 'Source Han Sans CN', 'Noto Sans SC', 'Source Han Sans TC', 'Noto Sans CJK TC', 'Helvetica', 'Hiragino Sans GB', sans-serif;
  }
</style>

  <!-- Custom CSS/Sass -->
  
<link rel="stylesheet" href="/css/style.css">

  <!--样式切换-->
  
  
<link rel="stylesheet" href="/css/material3.css">

  
  
  
  
  <!--highlight.js CSS-->
  
  
<link rel="stylesheet" href="/css/highlight/github.css">

  
  
  <!-- jquery -->
  
  <script src="/js/jquery.min.js"></script>
  
  <!--Comment-->
  
  <!--Waline-->
  <script src="/js/waline.js" defer></script>
  <link rel="stylesheet" href="/css/waline.css" />
  
  <!--Vercel Audiences Analytics-->
  
  <!--umami analytics-->
  
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HFH67WJVKQ" defer></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-HFH67WJVKQ');
  </script>
  
  
  
  
  
  <!-- Google Search Advanced
  https://developers.google.com/search/docs/advanced/structured-data/search-gallery
  -->
  
  
  
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "PHP编写守护进程",
      "image": "",
      "datePublished": "Mon Aug 05 2019 11:41:44 GMT+0800",
      "author": [{
        "@type": "Person",
        "name": "李恒",
        "url": "https://lihengtt.github.io"
      }]
    }
  </script>
  
  
  
  <!--<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      spacing: {
        '1': '8px',
        '2': '12px',
        '3': '16px',
        '4': '24px',
        '5': '32px',
        '6': '48px',
      },
      container: {
        center: true,
      },
      extend: {
        colors: {
          tblack: '#222831',
        },
        boxShadow: {
          'itp': '1px 10px 30px 0 rgb(0 0 0 / 10%)',
        }
      }
    }
  }
</script>-->

<link rel="stylesheet" href="/css/tailwind.css">

<meta name="generator" content="Hexo 8.1.1"></head>


<!--Other Pages-->


<body>
  <!-- Nav -->
  


<div class="itp-float-bar">
  <!--所有页面都显示-->
  <a class="itp-float-bar-item rounded" href="/" title="Harthali">
    
    <iconpark-icon class="navicon" name="home"></iconpark-icon>
    
  </a>
  
  <!--只在 **文章** 页面显示-->
  <a class="itp-float-bar-item rounded" onclick="scrollto(comment)" title="comment">
    
    <iconpark-icon class="navicon" name="comment"></iconpark-icon>
    
  </a>
  <a class="itp-float-bar-item rounded" id="open_toc" onclick="OpenToc()" title="Table of contents">
    
    <iconpark-icon class="navicon" name="list"></iconpark-icon>
    
  </a>
  <a class="itp-float-bar-item rounded" href="javascript:scroll(0,0)" title="to top">
    
    <iconpark-icon class="navicon" name="top"></iconpark-icon>
    
  </a>
  

  <div class="itp-float-layer itp-toc-layer">
    <div class="clost-btn" style="display: flex;">
      <a class="itp-float-layer-close-btn" id="close_btn">
        <div class="close_btn_red">
        </div>
      </a>
    </div>
    
  </div>
  <div class="itp-float-layer-bg layer-bg-nodisplay" id="close_layer"></div>
</div>


<style>
  .navicon {
    font-size: 18px;
    padding-top: 18px;
    color: var(--main-black);
  }
</style>
  <!-- Main Content -->
  

<section class="pjax-area">
  <div class="content-area post-content-area">
    <div class=" left-area"></div>
    <div class="main-area">
      <div class="itp-m3-card post-cover">
        <div class="itp-m3-card-cover">
          <div class="itp-m3-cover-bg" style="
          background-image: url();
          background-size: cover;
          background-position: center center;
        ">
            <div class="itp-m3-card-cover-layer ">
              <div class="info-area pjax-area">
                <div class="itp-m3-cover-avatar">
                  <img src="https://lihengc.github.io/images/WechatIMG10.jpeg" class="nofancy">
                </div>
                <div class="itp-m3-cover-title" style="opacity: 1;">
                  PHP编写守护进程
                </div>
                <div class="itp-m3-cover-subtitle" style="opacity: 0.8;">
                  
2019-08-05
<span> / </span>


<span> / </span>
3.5k
<style>
  .category-link {
    color: var(--main-black);
  }

  @media print {
    .itp-cover-subtitle a {
      color: var(--main-black) !important;
    }
  }

  @media screen {
    .itp-cover-subtitle a {
      color: #fff !important;
    }
  }
</style>

                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article">
          <ul>
<li><p>进程根据状态可以分为三种进程，守护进程，僵尸进程，孤儿进程。今天我们着重来分析下守护进程。</p>
<h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3>  <hr />
  #### 简介
  <span id="more"></span>
  守护进程 (daemon) 是一类在后台运行的特殊进程，用于执行特定的系统任务。很多守护进程在系统引导的时候启动，并且一直运行直到系统关闭。另一些只在需要的时候才启动，完成任务后就自动结束。
  
<h4 id="创建步骤"><a href="#创建步骤" class="headerlink" title="创建步骤"></a>创建步骤</h4></li>
</ul>
<p>####1. 创建子进程，终止父进程<br>    由于守护进程是脱离控制终端的，因此首先创建子进程，终止父进程，使得程序在 shell 终端里造成一个已经运行完毕的假象。<br>    之后所有的工作都在子进程中完成，而用户在 shell 终端里则可以执行其他的命令，从而使得程序以僵尸进程形式运行，在形式 I 上做到了与控制终端的脱离。<br>####2. 在子进程中创建新会话<br>    这个步骤是创建守护进程中最重要的一步，在这里使用的是系统函数 setsid。<br>    setsid 函数用于创建一个新的会话，并担任该会话组的组长。<br>    调用 setsid 的三个作用：让进程摆脱原会话的控制、让进程摆脱原进程组的控制和让进程摆脱原控制终端的控制。<br>    在调用 fork 函数时，子进程全盘拷贝父进程的会话期 (session，是一个或多个进程组的集合)、进程组、控制终端等，虽然父进程退出了，但原先的会话期、进程组、控制终端等并没有改变，因此，那还不是真正意义上使两者独立开来。<br>    setsid 函数能够使进程完全独立出来，从而脱离所有其他进程的控制。</p>
<p>####3. 改变工作目录<br>    使用fork创建的子进程会继承父进程的当前工作目录。<br>    由于子进程运行的过程中，当前目录所在的文件系统不能被卸载，因此，我们需要把当前工作目录换成其他路径，如<code>/</code>或<code>/tmp</code>等。<br>    改变工作目录的常见函数是chdir。<br>####4. 重设文件创建掩码<br>    文件创建掩码是指屏蔽掉文件创建时的对应位。<br>    由于使用 fork 函数新建的子进程继承了父进程的文件创建掩码，这就给该子进程使用文件带来了诸多的麻烦。<br>    因此，把文件创建掩码设置为 0，可以大大增强该守护进程的灵活性。<br>    设置文件创建掩码的函数是 umask，通常的使用方法为 umask (0)。<br>####5. 关闭文件描述符<br>    用 fork 新建的子进程会从父进程那里继承一些已经打开了的文件。<br>    这些被打开的文件可能永远不会被守护进程读或写，但它们一样消耗系统资源，可能导致所在的文件系统无法卸载。<br>    在上面的第二步之后，守护进程已经与所属的控制终端失去了联系。<br>    因此从终端输入的字符不可能达到守护进程，守护进程中用常规方法（如printf）输出的字符也不可能在终端上显示出来。<br>    所以，文件描述符为0、1和2 的3个文件（常说的输入、输出和报错）已经失去了存在的价值，也应被关闭。</p>
<p>##code：</p>
<pre><code class="language-php">&lt;?php

class Deamon
{
    protected $_pidFile;

    public function __construct()
    {
        $this-&gt;_pidFile = &#39;/var/www/html/queue/public/pid.log&#39;;
        $this-&gt;_checkPcntl();
    }

    /**
     * 创建守护进程核心函数
     * @return string|void
     */
    private function _demonize()
    {
        if (php_sapi_name() != &#39;cli&#39;) {
            die(&#39;Should run in CLI&#39;);
        }
        //创建子进程
        $pid = pcntl_fork();
        if ($pid == -1) {
            return &#39;fork faile&#39;;
        } elseif ($pid) {
            //终止父进程
            exit(&#39;parent process&#39;);
        }
        //在子进程中创建新的会话
        if (posix_setsid() === -1) {
            die(&#39;Could not detach&#39;);
        }
        //改变工作目录
        chdir(&#39;/&#39;);
        //重设文件创建的掩码
        umask(0);
        $fp = fopen($this-&gt;_pidFile, &#39;w&#39;) or die(&quot;Can&#39;t create pid file&quot;);
        //把当前进程的id写入到文件中
        fwrite($fp, posix_getpid());
        fclose($fp);
        //关闭文件描述符
        fclose(STDIN);
        fclose(STDOUT);
        fclose(STDERR);
        //运行守护进程的逻辑
        $this-&gt;job();
        return;
    }

    /**
     * 守护进程的任务
     */
    private function job()
    {
        //TODO 你的守护经常需要执行的任务
        while (true) {
            file_put_contents(&#39;/var/www/html/queue/public/job.log&#39;, &#39;job&#39; . PHP_EOL, FILE_APPEND);
            sleep(5);
        }
    }

    /**
     * 获取守护进程的id
     * @return int
     */
    private function _getPid()
    {
        //判断存放守护进程id的文件是否存在
        if (!file_exists($this-&gt;_pidFile)) {
            return 0;
        }
        $pid = intval(file_get_contents($this-&gt;_pidFile));
        if (posix_kill($pid, SIG_DFL)) {//判断该进程是否正常运行中
            return $pid;
        } else {
            unlink($this-&gt;_pidFile);
            return 0;
        }
    }

    /**
     * 判断pcntl拓展
     */
    private function _checkPcntl()
    {
        !function_exists(&#39;pcntl_signal&#39;) &amp;&amp; die(&#39;Error:Need PHP Pcntl extension!&#39;);
    }

    private function _message($message)
    {
        printf(&quot;%s  %d %d  %s&quot; . PHP_EOL, date(&quot;Y-m-d H:i:s&quot;), posix_getpid(), posix_getppid(), $message);
    }

    /**
     * 开启守护进程
     */
    private function start()
    {
        if ($this-&gt;_getPid() &gt; 0) {
            $this-&gt;_message(&#39;Running&#39;);
        } else {
            $this-&gt;_demonize();
            $this-&gt;_message(&#39;Start&#39;);
        }
    }

    /**
     * 停止守护进程
     */
    private function stop()
    {
        $pid = $this-&gt;_getPid();
        if ($pid &gt; 0) {
            //通过向进程id发送终止信号来停止进程
            posix_kill($pid, SIGTERM);
            unlink($this-&gt;_pidFile);
            echo &#39;Stoped&#39; . PHP_EOL;
        } else {
            echo &quot;Not Running&quot; . PHP_EOL;
        }
    }

    private function status()
    {
        if ($this-&gt;_getPid() &gt; 0) {
            $this-&gt;_message(&#39;Is Running&#39;);
        } else {
            echo &#39;Not Running&#39; . PHP_EOL;
        }
    }

    public function run($argv)
    {
        $param = is_array($argv) &amp;&amp; count($argv) == 2 ? $argv[1] : null;
        switch ($param) {
            case &#39;start&#39;:
                $this-&gt;start();
                break;
            case &#39;stop&#39;:
                $this-&gt;stop();
                break;
            case &#39;status&#39;:
                $this-&gt;status();
                break;
            default:
                echo &quot;Argv start|stop|status &quot; . PHP_EOL;
                break;
        }
    }

}

$deamon = new \Deamon();
$deamon-&gt;run($argv);
</code></pre>
<h3 id="运行方式"><a href="#运行方式" class="headerlink" title="运行方式"></a>运行方式</h3><ul>
<li>开启守护进程：php test.php start</li>
<li>停止守护进程：php test.php stop</li>
<li>查看守护进程的状态：php test.php status</li>
</ul>

        </div>
        <div class="itp-m3-post-info_area">
          <div class="info_area-category">
            
            
            <div class="itp-m3-chip-normal-list">
              <a class="tag-none-link" href="/tags/PHP/" rel="tag">PHP</a><a class="tag-none-link" href="/tags/swoole/" rel="tag">swoole</a>
            </div>
            
          </div>
          <div class="info_area-copyright">
            <p>本文著作权归作者&nbsp李恒&nbsp所有，转载或引用请联系作者获得授权。</p>
          </div>
        </div>
      </div>
      
      <div class="itp-m3-card itp-m3-post-comment_area" id="comment">
        
<div id="waline"></div>
<script>
  function startWaline() {
    Waline.init({
      el: '#waline',
      serverURL: 'https://comment.tripper.press/',
      path: '/2019/08/05/PHP%E7%BC%96%E5%86%99%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/',
      dark: 'auto',
      search: false,
      imageUploader: false,
      wordLimit: [5, 200],
      emoji: [
        'https://imgur.lzmun.com/press_assets/emojis/bili'
      ],
    })
  };
  document.addEventListener("DOMContentLoaded", startWaline);
</script>
<style>
  button[title="表情包"] {
    display: none;
  }

  .wl-panel {
    border-radius: 3px !important;
  }

  .wl-btn {
    border-radius: 3px !important;
  }

  .wl-power {
    text-align: center;
    opacity: 0.3;
  }
</style>

      </div>
      
    </div>
    <div class="right-area">
      
      

<div id="column-toc-m3" class="noprn column-toc-m3 itp-toc-m3-sidetop">
  <ol class="itp-toc"><li class="itp-toc-item itp-toc-level-3"><a class="itp-toc-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="itp-toc-text">守护进程</span></a></li><li class="itp-toc-item itp-toc-level-3"><a class="itp-toc-link" href="#%E8%BF%90%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="itp-toc-text">运行方式</span></a></li></ol>
</div>

      
    </div>
  </div>
  
  <!--
<div class="mdui-dialog" id="shareDialogText" style="text-align: center;">
  <div class="itp-share-card" id="shareInfo">
    <div class="itp-share-cover" style="background: url('');">
      <div class="itp-share-layer">
        <div class="itp-share-info">
          <div class="itp-share-avatar">
            <img src="https://lihengc.github.io/images/WechatIMG10.jpeg" class="nofancy">
          </div>
          <div class="itp-share-title">PHP编写守护进程</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="mdui-dialog" id="shareDialogImg" style="text-align: center;">
  分享图已生成
</div>-->
</section>
  <!-- Footer -->
  <!-- Footer -->
<footer class="itp-footer text-center">
  <section class="footer-info">
    Harthali &copy; 2016 - 2025
    
    <span> / </span>
    65k
    
    
    
    <span> / Theme</span>
    <a href="https://github.com/aiokr/hexo-theme-type" target="_blank">Type
    </a>
  </section>
  
    <a href="../about/" target="_blank">
      <img width="80px" height="80px" style="padding-top: 12px; display: block; margin: 0 auto;" src="https://imgur.lzmun.com/picgo/after2022/tripper2whitefull.png_avatar" alt="footer logo"></a>
  
</footer>
  <!-- After footer scripts -->
  <!-- fancybox -->

<script src="/js/fancybox.umd.js" defer></script>
<link rel="stylesheet" href="/css/fancybox.css" />

<!-- mdui -->

<!-- busuanzi -->

<!-- highlightjs -->


<script src="/js/highlight.min.js" async></script>

<script>window.addEventListener('load', () => hljs.initHighlighting());</script>
<script>
  $("pre.code").each(function() {
    $(this).html("<ol><li>" + $(this).html().replace(/\n/g, "\n</li><li>") + "\n</li></ol>");
  });
</script>



<script src="/js/app.js"></script>



<!--

<script src="/js/canvas2image.js"></script>


<script src="/js/shareimg.js"></script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.js" defer></script>
-->
<!--lazyload-->


<script src="/js/lazyload.js"></script>


<!--PJAX-->
<!--Pjax from https://github.com/MoOx/pjax-->

<!--<script src="https://cdn.jsdelivr.net/npm/pjax/pjax.js"></script>-->
<!---->
<!---->
<!---->
<!---->
<!--首页键盘快捷键-->

  <style>
  :root {
    --main-color: #71AFDD;
    --sub-color: #6CD9CE;
    --main-black: #222831;
  }
</style>
</body>




</html>
