<!-- @format -->



<!DOCTYPE html>
<html lang="en">
<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <!--360 使用 Google Chrome Frame-->
  <meta name="renderer" content="webkit">
  <!--百度禁止转码-->
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <!--Description-->
  
  <meta name="description" content="php-fpm slow log 慢日志分析,phpfpm性能分析">
  
  <meta name="google-site-verification" content="J4gssmXGNI9-DfJ9w52mL5KFPlRCYvySveEN0RJFZHU" />
  <!--Author-->
  
  <meta name="author" content="李恒">
  
  <!--Open Graph Title-->
  <meta property="og:title" content="slow log慢日志分析,phpfpm性能分析" />
  <!--Open Graph Description-->
  <meta property="og:description" content="php-fpm slow log 慢日志分析,phpfpm性能分析" />
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="Harthali" />
  <!--Type page-->
  
  <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  
  <meta property="og:image" content="/null" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Title -->
  
  <title>slow log慢日志分析,phpfpm性能分析 - Harthali</title>
  <!-- 添加到主屏后的标题（iOS 6 新增） -->
  <meta name="apple-mobile-web-app-title" content="Harthali">
  <!-- 是否启用 WebApp 全屏模式 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-startup-image" href="/assets/ splash-assets.png" media="(max-device-width: 700px)">
  <!-- 禁止数字识自动别为电话号码 -->
  <meta name="format-detection" content="telephone=no" />
  <link rel="shortcut icon" href="/null">
  <!--Apple iOS Safari ICON-->
  <link rel="apple-touch-icon" sizes="57x57" href="" />
  <link rel="apple-touch-icon" sizes="72x72" href="" />
  <link rel="apple-touch-icon" sizes="114x114" href="" />
  <link rel="apple-touch-icon" sizes="144x144" href="" />
  <!-- 添加 RSS 订阅 -->
  <link rel="alternate" type="application/rss+xml" title="Harthali" href="/atom.xml" />
  <!-- uc强制竖屏 -->
  <meta name="screen-orientation" content="portrait">
  <!-- QQ强制竖屏 -->
  <meta name="x5-orientation" content="portrait">
  <!-- UC强制全屏 -->
  <meta name="full-screen" content="yes">
  <!-- QQ强制全屏 -->
  <meta name="x5-fullscreen" content="true">
  <!-- UC应用模式 -->
  <meta name="browsermode" content="application">
  <!-- QQ应用模式 -->
  <meta name="x5-page-mode" content="app">
  <!-- https://material.io/resources/icons/?style=outline -->
  
  <script src="https://lf1-cdn-tos.bytegoofy.com/obj/iconpark/icons_20213_18.4a5f87dae8e6f9e336b9ad6fa00f8e8f.js"></script>
  
  
<style>
  .itp-gallery-title,
  .itp-gallery-subtitle,
  .itp-post-title,
  .itp-post-entry-title,
  .itp-post-entry-subtitle,
  .itp-mag-logo,
  .itp-index-title,
  .itp-post-entry-moment,
  .itp-header-actions-menu {
    font-family: ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
  }

  .itp-header-title,
  .itp-m3-post-entry-info .title,
  .itp-header-actions,
  .itp-cover-title,
  .itp-cover-subtitle,
  .itp-post-subtitle,
  .itp-post-entry-title,
  .itp-m3-cover-subtitle,
  .itp-m3-cover-title,
  .itp-gallery-info .title,
  .footer-info {
    font-family: ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
  }

  .article,
  .itp-post-entry-excerpt {
    font-family: 'SF UI Display', '.PingFang SC', 'PingFang SC', 'Neue Haas Grotesk Text Pro', 'Arial Nova', 'Segoe UI', 'Microsoft YaHei', 'Microsoft JhengHei', 'Helvetica Neue', 'Source Han Sans SC', 'Noto Sans CJK SC', 'Source Han Sans CN', 'Noto Sans SC', 'Source Han Sans TC', 'Noto Sans CJK TC', 'Helvetica', 'Hiragino Sans GB', sans-serif;
  }
</style>

  <!-- Custom CSS/Sass -->
  
<link rel="stylesheet" href="/css/style.css">

  <!--样式切换-->
  
  
<link rel="stylesheet" href="/css/material3.css">

  
  
  
  
  <!--highlight.js CSS-->
  
  
<link rel="stylesheet" href="/css/highlight/github.css">

  
  
  <!-- jquery -->
  
  <script src="/js/jquery.min.js"></script>
  
  <!--Comment-->
  
  <!--Waline-->
  <script src="/js/waline.js" defer></script>
  <link rel="stylesheet" href="/css/waline.css" />
  
  <!--Vercel Audiences Analytics-->
  
  <!--umami analytics-->
  
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HFH67WJVKQ" defer></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-HFH67WJVKQ');
  </script>
  
  
  
  <!-- Google Search Advanced
  https://developers.google.com/search/docs/advanced/structured-data/search-gallery
  -->
  
  
  
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "slow log慢日志分析,phpfpm性能分析",
      "image": "",
      "datePublished": "Thu Aug 15 2019 11:23:16 GMT+0800",
      "author": [{
        "@type": "Person",
        "name": "李恒",
        "url": "https://lihengtt.github.io"
      }]
    }
  </script>
  
  
  
  <!--<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      spacing: {
        '1': '8px',
        '2': '12px',
        '3': '16px',
        '4': '24px',
        '5': '32px',
        '6': '48px',
      },
      container: {
        center: true,
      },
      extend: {
        colors: {
          tblack: '#222831',
        },
        boxShadow: {
          'itp': '1px 10px 30px 0 rgb(0 0 0 / 10%)',
        }
      }
    }
  }
</script>-->

<link rel="stylesheet" href="/css/tailwind.css">

<meta name="generator" content="Hexo 8.1.1"></head>


<!--Other Pages-->


<body>
  <!-- Nav -->
  


<div class="itp-float-bar">
  <!--所有页面都显示-->
  <a class="itp-float-bar-item rounded" href="/" title="Harthali">
    
    <iconpark-icon class="navicon" name="home"></iconpark-icon>
    
  </a>
  
  <!--只在 **非文章** 页面显示-->
  
  <a class="itp-float-bar-item rounded" href="/archives/" title="归档">
    
    <iconpark-icon class="navicon" name="inbox"></iconpark-icon>
    
  </a>
  
  <a class="itp-float-bar-item rounded" href="/gallery/" title="影像">
    
    <iconpark-icon class="navicon" name="gallery"></iconpark-icon>
    
  </a>
  
  <a class="itp-float-bar-item rounded" href="/about/" title="关于">
    
    <iconpark-icon class="navicon" name="person"></iconpark-icon>
    
  </a>
  
  <a class="itp-float-bar-item rounded" href="/links/" title="链接">
    
    <iconpark-icon class="navicon" name="people"></iconpark-icon>
    
  </a>
  
  
  

  <div class="itp-float-layer itp-toc-layer">
    <div class="clost-btn" style="display: flex;">
      <a class="itp-float-layer-close-btn" id="close_btn">
        <div class="close_btn_red">
        </div>
      </a>
    </div>
    
  </div>
  <div class="itp-float-layer-bg layer-bg-nodisplay" id="close_layer"></div>
</div>


<style>
  .navicon {
    font-size: 18px;
    padding-top: 18px;
    color: var(--main-black);
  }
</style>
  <!-- Main Content -->
  

<section class="pjax-area">
  <div class="content-area post-content-area">
    <div class=" left-area"></div>
    <div class="main-area">
      <div class="itp-m3-card post-cover">
        <div class="itp-m3-card-cover">
          <div class="itp-m3-cover-bg" style="
          background-image: url();
          background-size: cover;
          background-position: center center;
        ">
            <div class="itp-m3-card-cover-layer ">
              <div class="info-area pjax-area">
                <div class="itp-m3-cover-avatar">
                  <img src="https://lihengc.github.io/images/WechatIMG10.jpeg" class="nofancy">
                </div>
                <div class="itp-m3-cover-title" style="opacity: 1;">
                  slow log慢日志分析,phpfpm性能分析
                </div>
                <div class="itp-m3-cover-subtitle" style="opacity: 0.8;">
                  
2019-08-15
<span> / </span>


<span> / </span>
2.1k
<style>
  .category-link {
    color: var(--main-black);
  }

  @media print {
    .itp-cover-subtitle a {
      color: var(--main-black) !important;
    }
  }

  @media screen {
    .itp-cover-subtitle a {
      color: #fff !important;
    }
  }
</style>

                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article">
          <p>我们都知道mysql是有slow query log，根据慢查询日志，我们可以知道那些sql语句有性能问题<br>当然php也是具有慢日志的，如果你使用php-fpm来管理php的话，你可以通过如下选项开启。</p>
<span id="more"></span>
<h4 id="PHP-5-3-3-之前设置如下："><a href="#PHP-5-3-3-之前设置如下：" class="headerlink" title="PHP 5.3.3 之前设置如下："></a>PHP 5.3.3 之前设置如下：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;value name=&quot;request_slowlog_timeout&quot;&gt;5s&lt;/value&gt;</span><br><span class="line">&lt;value name=&quot;slowlog&quot;&gt;logs/php-fpm-slowlog.log&lt;/value&gt;</span><br></pre></td></tr></table></figure>

<h4 id="PHP-5-3-3-之后设置以下如下：php-fpm-conf"><a href="#PHP-5-3-3-之后设置以下如下：php-fpm-conf" class="headerlink" title="PHP 5.3.3 之后设置以下如下：php-fpm.conf"></a>PHP 5.3.3 之后设置以下如下：php-fpm.conf</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request_slowlog_timeout = 5s</span><br><span class="line">slowlog = /usr/local/php/log/php-fpm-slowlog.log</span><br></pre></td></tr></table></figure>
<p>说明:</p>
<p>request_slowlog_timeout 是脚本超过多长时间 就可以记录到日志文件</p>
<p>slowlog 是日志文件的路径</p>
<h4 id="开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息："><a href="#开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息：" class="headerlink" title="开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息："></a>开启后，如果有脚本执行超过指定的时间，就会在指定的日志文件中写入类似如下的信息：</h4><figure class="highlight plaintext"><figcaption><span>log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[15-Aug-2019 14:50:19] [pool www] pid 18575</span><br><span class="line">script_filename = /home/web/htdocs/xxxx/test/tt.php</span><br><span class="line">[0x0000000003a00dc8] curl_exec() /home/web/htdocs/xxxx/test/tt.php:2</span><br><span class="line">[0x0000000003a00cd0] exfilter_curl_get() /home/web/htdocs/xxxx/test/tt.php:6</span><br></pre></td></tr></table></figure>
<h4 id="日志说明："><a href="#日志说明：" class="headerlink" title="日志说明："></a>日志说明：</h4><ol>
<li>script_filename 是入口文件</li>
<li>curl_exec() ： 说明是执行这个方法的时候超过执行时间的。</li>
<li>exfilter_curl_get() ：说明调用curl_exec()的方法是exfilter_curl_get() 。</li>
<li>每行冒号后面的数字是行号。</li>
</ol>
<p>开启后，在错误日志文件中也有相关记录。如下：</p>
<figure class="highlight plaintext"><figcaption><span>log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[15-Aug-2019 15:55:37] WARNING: [pool www] child 18575, script &#x27;/home/web/htdocs/xxxxlong/test/tt.php&#x27; (request: &quot;GET /test/tt.php&quot;) executing too slow (1.006222 sec), logging</span><br><span class="line">[15-Aug-2019 15:55:37] NOTICE: child 18575 stopped for tracing</span><br><span class="line">[15-Aug-2019 15:55:37] NOTICE: about to trace 18575</span><br><span class="line">[15-Aug-2019 15:55:37] NOTICE: finished trace of 18575</span><br></pre></td></tr></table></figure>
<h3 id="Docker-php-fpm-慢查询-failed-to-ptrace-Operation-not-permitted解决方案"><a href="#Docker-php-fpm-慢查询-failed-to-ptrace-Operation-not-permitted解决方案" class="headerlink" title="Docker php-fpm 慢查询 failed to ptrace Operation not permitted解决方案"></a>Docker php-fpm 慢查询 failed to ptrace Operation not permitted解决方案</h3><p>宿主机的服务慢查询是正常的，但是到了Docker中的php-fpm服务，触发慢查询后，会输出类似报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[15-Aug-2019 15:59:17] ERROR: failed to ptrace(ATTACH) child 5118: Operation not permitted (1)</span><br><span class="line">[15-Aug-2019 15:59:17] WARNING: [pool www] child 5118, script &#x27;/www/index.php&#x27; (request: &quot;GET /index.php&quot;) executing too slow (1.021099 sec), logging</span><br></pre></td></tr></table></figure>

<p>开始没想到的Docker容器权限问题，后来搜了下，在serverfault找到了解决方案：<br>容器启动时，加入参数：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--cap-<span class="keyword">add</span><span class="language-bash"> SYS_PTRACE</span></span><br></pre></td></tr></table></figure>
<p>解决方案来自：<a target="_blank" rel="noopener" href="https://serverfault.com/questions/704007/php-slowlog-causing-ptrace-error-in-docker-container/706982#706982">https://serverfault.com/questions/704007/php-slowlog-causing-ptrace-error-in-docker-container/706982#706982</a></p>
<hr>
<ul>
<li>系统日志：记录系统相关信息：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ty_hf/article/details/55511624">http://blog.csdn.net/ty_hf/article/details/55511624</a></li>
<li>apache访问日志与错误日志：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ty_hf/article/details/55504719">http://blog.csdn.net/ty_hf/article/details/55504719</a></li>
<li>nginx访问日志与错误日志：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ty_hf/article/details/55518070">http://blog.csdn.net/ty_hf/article/details/55518070</a></li>
<li>php-fpm慢日志：检测执行较慢的PHP脚本：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ty_hf/article/details/55504172">http://blog.csdn.net/ty_hf/article/details/55504172</a></li>
<li>php错误日志：检测php运行时或用户自记录错误日志：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ty_hf/article/details/55505262">http://blog.csdn.net/ty_hf/article/details/55505262</a></li>
<li>mysql慢日志：记录mysql服务器中影响性能的SQL：<a target="_blank" rel="noopener" href="http://blog.csdn.net/ty_hf/article/details/55504172">http://blog.csdn.net/ty_hf/article/details/55504172</a></li>
</ul>

        </div>
        <div class="itp-m3-post-info_area">
          <div class="info_area-category">
            
            
            <div class="itp-m3-chip-normal-list">
              <a class="tag-none-link" href="/tags/php/" rel="tag">php</a><a class="tag-none-link" href="/tags/php-fpm/" rel="tag">php-fpm</a>
            </div>
            
          </div>
          <div class="info_area-copyright">
            <p>本文著作权归作者&nbsp李恒&nbsp所有，转载或引用请联系作者获得授权。</p>
          </div>
        </div>
      </div>
      
      <div class="itp-m3-card itp-m3-post-comment_area" id="comment">
        
<div id="waline"></div>
<script>
  function startWaline() {
    Waline.init({
      el: '#waline',
      serverURL: 'https://comment.tripper.press/',
      path: '/2019/08/15/%E6%85%A2%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90-phpfpm%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/',
      dark: 'auto',
      search: false,
      imageUploader: false,
      wordLimit: [5, 200],
      emoji: [
        'https://imgur.lzmun.com/press_assets/emojis/bili'
      ],
    })
  };
  document.addEventListener("DOMContentLoaded", startWaline);
</script>
<style>
  button[title="表情包"] {
    display: none;
  }

  .wl-panel {
    border-radius: 3px !important;
  }

  .wl-btn {
    border-radius: 3px !important;
  }

  .wl-power {
    text-align: center;
    opacity: 0.3;
  }
</style>

      </div>
      
    </div>
    <div class="right-area">
      
      

<div id="column-toc-m3" class="noprn column-toc-m3 itp-toc-m3-sidetop">
  <ol class="itp-toc"><li class="itp-toc-item itp-toc-level-3"><a class="itp-toc-link" href="#Docker-php-fpm-%E6%85%A2%E6%9F%A5%E8%AF%A2-failed-to-ptrace-Operation-not-permitted%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="itp-toc-text">Docker php-fpm 慢查询 failed to ptrace Operation not permitted解决方案</span></a></li></ol>
</div>

      
    </div>
  </div>
  
  <!--
<div class="mdui-dialog" id="shareDialogText" style="text-align: center;">
  <div class="itp-share-card" id="shareInfo">
    <div class="itp-share-cover" style="background: url('');">
      <div class="itp-share-layer">
        <div class="itp-share-info">
          <div class="itp-share-avatar">
            <img src="https://lihengc.github.io/images/WechatIMG10.jpeg" class="nofancy">
          </div>
          <div class="itp-share-title">slow log慢日志分析,phpfpm性能分析</div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="mdui-dialog" id="shareDialogImg" style="text-align: center;">
  分享图已生成
</div>-->
</section>
  <!-- Footer -->
  <!-- Footer -->
<footer class="itp-footer text-center">
  <section class="footer-info">
    Harthali &copy; 2016 - 2025
    
    <span> / </span>
    68k
    
    
    
    <span> / Theme</span>
    <a href="https://github.com/aiokr/hexo-theme-type" target="_blank">Type
    </a>
  </section>
  
    <a href="../about/" target="_blank">
      <img width="80px" height="80px" style="padding-top: 12px; display: block; margin: 0 auto;" src="https://imgur.lzmun.com/picgo/after2022/tripper2whitefull.png_avatar" alt="footer logo"></a>
  
</footer>
  <!-- After footer scripts -->
  <!-- fancybox -->

<script src="/js/fancybox.umd.js" defer></script>
<link rel="stylesheet" href="/css/fancybox.css" />

<!-- mdui -->

<!-- busuanzi -->

<!-- highlightjs -->


<script src="/js/highlight.min.js" async></script>

<script>window.addEventListener('load', () => hljs.initHighlighting());</script>
<script>
  $("pre.code").each(function() {
    $(this).html("<ol><li>" + $(this).html().replace(/\n/g, "\n</li><li>") + "\n</li></ol>");
  });
</script>



<script src="/js/app.js"></script>



<!--

<script src="/js/canvas2image.js"></script>


<script src="/js/shareimg.js"></script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.js" defer></script>
-->
<!--lazyload-->


<script src="/js/lazyload.js"></script>


<!--PJAX-->
<!--Pjax from https://github.com/MoOx/pjax-->

<!--<script src="https://cdn.jsdelivr.net/npm/pjax/pjax.js"></script>-->
<!---->
<!---->
<!---->
<!---->
<!--首页键盘快捷键-->

  <style>
  :root {
    --main-color: #71AFDD;
    --sub-color: #6CD9CE;
    --main-black: #222831;
  }
</style>
</body>




</html>
